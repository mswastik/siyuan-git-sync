"use strict";var Oe=Object.defineProperty;var je=(r,e,t)=>e in r?Oe(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t;var p=(r,e,t)=>je(r,typeof e!="symbol"?e+"":e,t);Object.defineProperties(exports,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}});const w=require("siyuan");async function E(r,e){let t=await w.fetchSyncPost(r,e);return t.code===0?t.data:null}async function qe(r,e,t){return E("/api/filetree/createDocWithMd",{notebook:r,path:e,markdown:t})}async function Re(r,e){return E("/api/filetree/listDocsByPath",{notebook:r,path:e})}async function He(r,e,t){return E("/api/filetree/renameDoc",{notebook:r,path:e,title:t})}async function Fe(r,e){return E("/api/filetree/removeDoc",{notebook:r,path:e})}async function Pe(r,e,t,s,n){return E("/api/block/insertBlock",{dataType:r,data:e,nextID:t,previousID:s,parentID:n})}async function Se(r,e,t){return E("/api/block/updateBlock",{dataType:r,data:e,id:t})}async function fe(r,e){return E("/api/attr/setBlockAttrs",{id:r,attrs:e})}async function J(r){return E("/api/query/sql",{stmt:r})}const Ve=async r=>{let t=await fetch("/api/file/getFile",{method:"POST",body:JSON.stringify({path:r})});return t.ok?await t.blob():null};async function ze(r,e,t){let s=new FormData;return s.append("path",r),s.append("isDir",e.toString()),s.append("modTime",Math.floor(Date.now()/1e3).toString()),s.append("file",t),E("/api/file/putFile",s)}async function We(r){return E("/api/file/readDir",{path:r})}function Ue(r,e){let t;return function(...s){clearTimeout(t),t=setTimeout(()=>r(...s),e)}}const Ke=()=>w.getFrontend().endsWith("mobile"),W=(r,e)=>{Ke()?w.openMobileFileById(exports.app,r):w.openTab({app:exports.app,doc:{id:r,zoomIn:(e==null?void 0:e.zoomIn)??!1,action:(e==null?void 0:e.action)??[]},position:e==null?void 0:e.position,keepCursor:e==null?void 0:e.keepCursor})},ee=r=>{let e=window.siyuan.notebooks;for(let t of e)if(t.id===r)return t},Qe=r=>{let e;switch(r){case"checkbox":e=t=>t.checked;break;case"select":case"slider":case"textinput":case"textarea":e=t=>t.value;break;case"number":e=t=>parseInt(t.value);break;default:e=()=>null;break}return e},Je=r=>{let e;switch(r){case"checkbox":e=(t,s)=>{t.checked=s};break;case"select":case"slider":case"textinput":case"textarea":case"number":e=(t,s)=>{t.value=s};break;default:e=()=>{};break}return e};class Ge{constructor(e){p(this,"plugin");p(this,"name");p(this,"file");p(this,"settings",new Map);p(this,"elements",new Map);this.name=e.name??"settings",this.plugin=e.plugin,this.file=this.name.endsWith(".json")?this.name:`${this.name}.json`,this.plugin.setting=new w.Setting({width:e.width,height:e.height,confirmCallback:()=>{for(let s of this.settings.keys())this.updateValueFromElement(s);let t=this.dump();e.callback!==void 0&&e.callback(t),this.plugin.data[this.name]=t,this.save(t)},destroyCallback:()=>{for(let t of this.settings.keys())this.updateElementFromValue(t)}})}async load(){let e=await this.plugin.loadData(this.file);if(console.debug("Load config:",e),e)for(let[t,s]of this.settings)s.value=(e==null?void 0:e[t])??s.value;return this.plugin.data[this.name]=this.dump(),e}async save(e){return e=e??this.dump(),await this.plugin.saveData(this.file,this.dump()),console.debug("Save config:",e),e}get(e){var t;return(t=this.settings.get(e))==null?void 0:t.value}set(e,t){let s=this.settings.get(e);s&&(s.value=t,this.updateElementFromValue(e))}async setAndSave(e,t){let s=this.settings.get(e);s&&(s.value=t,this.updateElementFromValue(e),await this.save())}take(e,t=!1){let s=this.settings.get(e),n=this.elements.get(e);if(n)return t&&this.updateValueFromElement(e),s.getEleVal(n)}async takeAndSave(e){let t=this.take(e,!0);return await this.save(),t}disable(e){let t=this.elements.get(e);t&&(t.disabled=!0)}enable(e){let t=this.elements.get(e);t&&(t.disabled=!1)}dump(){let e={};for(let[t,s]of this.settings)s.type!=="button"&&(e[t]=s.value);return e}addItem(e){if(this.settings.set(e.key,e),e.type==="custom"&&(e.createElement===void 0||e.getEleVal===void 0||e.setEleVal===void 0)){console.error("The custom setting item must have createElement, getEleVal and setEleVal methods");return}if(e.getEleVal===void 0&&(e.getEleVal=Qe(e.type)),e.setEleVal===void 0&&(e.setEleVal=Je(e.type)),e.createElement===void 0){let n=this.createDefaultElement(e);this.elements.set(e.key,n),this.plugin.setting.addItem({title:e.title,description:e==null?void 0:e.description,direction:e==null?void 0:e.direction,createActionElement:()=>(this.updateElementFromValue(e.key),this.getElement(e.key))})}else this.plugin.setting.addItem({title:e.title,description:e==null?void 0:e.description,direction:e==null?void 0:e.direction,createActionElement:()=>{let n=this.get(e.key),i=e.createElement(n);return this.elements.set(e.key,i),i}})}createDefaultElement(e){var n,i,a,o,l,c,d,m,h;let t;const s=u=>{u.key==="Enter"&&(u.preventDefault(),u.stopImmediatePropagation())};switch(e.type){case"checkbox":let u=document.createElement("input");u.type="checkbox",u.checked=e.value,u.className="b3-switch fn__flex-center",t=u,u.onchange=((n=e.action)==null?void 0:n.callback)??(()=>{});break;case"select":let f=document.createElement("select");f.className="b3-select fn__flex-center fn__size200";let g=(e==null?void 0:e.options)??{};for(let M in g){let U=document.createElement("option"),Be=g[M];U.value=M,U.text=Be,f.appendChild(U)}f.value=e.value,f.onchange=((i=e.action)==null?void 0:i.callback)??(()=>{}),t=f;break;case"slider":let y=document.createElement("input");y.type="range",y.className="b3-slider fn__size200 b3-tooltips b3-tooltips__n",y.ariaLabel=e.value,y.min=((a=e.slider)==null?void 0:a.min.toString())??"0",y.max=((o=e.slider)==null?void 0:o.max.toString())??"100",y.step=((l=e.slider)==null?void 0:l.step.toString())??"1",y.value=e.value,y.onchange=()=>{var M;y.ariaLabel=y.value,(M=e.action)==null||M.callback()},t=y;break;case"textinput":let x=document.createElement("input");x.className="b3-text-field fn__flex-center fn__size200",x.value=e.value,x.onchange=((c=e.action)==null?void 0:c.callback)??(()=>{}),t=x,x.addEventListener("keydown",s);break;case"textarea":let k=document.createElement("textarea");k.className="b3-text-field fn__block",k.value=e.value,k.onchange=((d=e.action)==null?void 0:d.callback)??(()=>{}),t=k;break;case"number":let q=document.createElement("input");q.type="number",q.className="b3-text-field fn__flex-center fn__size200",q.value=e.value,t=q,q.addEventListener("keydown",s);break;case"button":let R=document.createElement("button");R.className="b3-button b3-button--outline fn__flex-center fn__size200",R.innerText=((m=e.button)==null?void 0:m.label)??"Button",R.onclick=((h=e.button)==null?void 0:h.callback)??(()=>{}),t=R;break;case"hint":let C=document.createElement("div");C.className="b3-label fn__flex-center",t=C;break}return e.direction==="row"&&t.classList.remove("fn__size200"),t}getElement(e){return this.elements.get(e)}updateValueFromElement(e){let t=this.settings.get(e);if(t.type==="button")return;let s=this.elements.get(e);t.value=t.getEleVal(s)}updateElementFromValue(e){let t=this.settings.get(e);if(t.type==="button")return;let s=this.elements.get(e);t.setEleVal(s,t.value)}}const Ye=r=>{let e=globalThis.Lute.New();if(e.SetSpellcheck(window.siyuan.config.editor.spellcheck),e.SetProtyleMarkNetImg(window.siyuan.config.editor.displayNetImgMark),e.SetFileAnnotationRef(!0),e.SetTextMark(!0),e.SetHeadingID(!1),e.SetYamlFrontMatter(!1),e.SetInlineMathAllowDigitAfterOpenMarker(!0),e.SetToC(!1),e.SetIndentCodeBlock(!1),e.SetParagraphBeginningSpace(!0),e.SetSetext(!1),e.SetFootnotes(!1),e.SetLinkRef(!1),e.SetImgPathAllowSpace(!0),e.SetKramdownIAL(!0),e.SetTag(!0),e.SetSuperBlock(!0),e.SetMark(!0),e.SetInlineAsterisk(window.siyuan.config.editor.markdown.inlineAsterisk),e.SetInlineUnderscore(window.siyuan.config.editor.markdown.inlineUnderscore),e.SetSup(window.siyuan.config.editor.markdown.inlineSup),e.SetSub(window.siyuan.config.editor.markdown.inlineSub),e.SetTag(window.siyuan.config.editor.markdown.inlineTag),e.SetInlineMath(window.siyuan.config.editor.markdown.inlineMath),e.SetGFMStrikethrough1(!1),e.SetGFMStrikethrough(window.siyuan.config.editor.markdown.inlineStrikethrough),e.SetMark(window.siyuan.config.editor.markdown.inlineMark),e.SetProtyleWYSIWYG(!0),e.SetBlockRef(!0),e.SetHTMLTag2TextMark(!0),window.siyuan.emojis[0].items.length>0){const t={};window.siyuan.emojis[0].items.forEach(s=>{t[s.keywords]=r.emojiSite+"/"+s.unicode}),e.PutEmojis(t)}return e};let te=null;const $e=()=>{te||(te=Ye({}))},G=()=>(te||$e(),te),Xe=r=>{const e=parseInt(r.slice(0,4),10),t=parseInt(r.slice(4,6),10)-1,s=parseInt(r.slice(6,8),10),n=parseInt(r.slice(8,10),10),i=parseInt(r.slice(10,12),10),a=parseInt(r.slice(12,14),10);return new Date(e,t,s,n,i,a)},Ze=(r,e)=>{for(let t in e)r=r.replace(t,e[t]);return r},O=(r,e)=>{e=e||new Date;let t=e.getFullYear(),s=e.getMonth()+1,n=e.getDate(),i=e.getHours(),a=e.getMinutes(),o=e.getSeconds();return Ze(r,{yyyy:t.toString(),MM:s.toString().padStart(2,"0"),dd:n.toString().padStart(2,"0"),HH:i.toString().padStart(2,"0"),mm:a.toString().padStart(2,"0"),ss:o.toString().padStart(2,"0"),yy:t.toString().slice(-2)})},et={d:"文档",h:"标题",l:"列表",o:"有序列表",u:"无序列表",i:"列表项",c:"代码",m:"数学公式",t:"表格",b:"引述",sb:"超级块",p:"段落",html:"HTML块",query_embed:"嵌入块",av:"属性视图",widget:"挂件",tb:"分割线",audio:"音频",video:"视频",iframe:"IFrame",h1:"一级标题",h2:"二级标题",h3:"三级标题",h4:"四级标题",h5:"五级标题",h6:"六级标题"},tt={d:"Document",h:"Heading",l:"List",o:"Ordered List",u:"Unordered List",i:"ListItem",c:"Code",m:"Math",t:"Table",b:"Blockquote",sb:"SuperBlock",p:"Paragraph",html:"HTML",query_embed:"Embed",av:"Attribute View",widget:"Widget",tb:"Thematic Break",audio:"Audio",video:"Video",iframe:"IFrame",h1:"Heading 1",h2:"Heading 2",h3:"Heading 3",h4:"Heading 4",h5:"Heading 5",h6:"Heading 6"},P=window.siyuan.config.lang.startsWith("zh")?et:tt,se=(r,e)=>new Promise(t=>{if(document.getElementById(e))return t(!1),!1;const s=document.createElement("script");s.src=r,s.async=!0,document.head.appendChild(s),s.onload=()=>{if(document.getElementById(e))return s.remove(),t(!1),!1;s.id=e,t(!0)}}),st=(r,e)=>{if(!document.getElementById(e)){const t=document.createElement("link");t.id=e,t.rel="stylesheet",t.type="text/css",t.href=r;const s=document.querySelector("#pluginsStyle");s?s.before(t):document.getElementsByTagName("head")[0].appendChild(t)}},N=r=>!!r.match(/^\d{14}-[a-z0-9]{7}$/);function A(r,e){if(!r)return e;if(!e)return r;const t={...r};return Object.keys(e).forEach(s=>{const n=r[s],i=e[s];if(i!==void 0){if(i===null){t[s]=null;return}if(Array.isArray(i)){t[s]=Array.isArray(n)?n.map((a,o)=>i[o]!==void 0?typeof a=="object"&&typeof i[o]=="object"?A(a,i[o]):i[o]:a).concat(i.slice((n==null?void 0:n.length)||0)):[...i];return}if(typeof i=="object"&&Object.keys(i).length>0){t[s]=typeof n=="object"?A(n,i):i;return}t[s]=i}}),t}const rt=async()=>{if(window.katex)return;const r=w.Constants.PROTYLE_CDN;return st(`${r}/js/katex/katex.min.css`,"protyleKatexStyle"),await se(`${r}/js/katex/katex.min.js`,"protyleKatexScript"),window.katex!==void 0&&window.katex!==null},nt="_columns_1n62w_73",it="_column_1n62w_73",at="_rows_1n62w_88",ot="_row_1n62w_88",_={"data-query-embed":"_data-query-embed_1n62w_2","data-view-component":"_data-view-component_1n62w_6","markdown-component":"_markdown-component_1n62w_13","embed-container":"_embed-container_1n62w_18","embed-jump-icon":"_embed-jump-icon_1n62w_27","embed-more-svg":"_embed-more-svg_1n62w_48","remove-mermaid":"_remove-mermaid_1n62w_64","mindmap-node-siyuan":"_mindmap-node-siyuan_1n62w_69",columns:nt,column:it,rows:at,row:ot,"katex-center-display":"_katex-center-display_1n62w_100"},lt={d:"NodeDocument",p:"NodeParagraph",query_embed:"NodeBlockQueryEmbed",l:"NodeList",i:"NodeListItem",h:"NodeHeading",iframe:"NodeIFrame",tb:"NodeThematicBreak",b:"NodeBlockquote",s:"NodeSuperBlock",c:"NodeCodeBlock",widget:"NodeWidget",t:"NodeTable",html:"NodeHTMLBlock",m:"NodeMathBlock",av:"NodeAttributeView",audio:"NodeAudio"},ct={NodeAttributeView:{icon:"iconDatabase"},NodeAudio:{icon:"iconRecord"},NodeBlockQueryEmbed:{icon:"iconSQL"},NodeBlockquote:{icon:"iconQuote"},NodeCodeBlock:{icon:"iconCode"},NodeDocument:{icon:"iconFile"},NodeHTMLBlock:{icon:"iconHTML5"},NodeHeading:{icon:"iconHeadings",subtypes:{h1:{icon:"iconH1"},h2:{icon:"iconH2"},h3:{icon:"iconH3"},h4:{icon:"iconH4"},h5:{icon:"iconH5"},h6:{icon:"iconH6"}}},NodeIFrame:{icon:"iconLanguage"},NodeList:{subtypes:{o:{icon:"iconOrderedList"},t:{icon:"iconCheck"},u:{icon:"iconList"}}},NodeListItem:{icon:"iconListItem"},NodeMathBlock:{icon:"iconMath"},NodeParagraph:{icon:"iconParagraph"},NodeSuperBlock:{icon:"iconSuper"},NodeTable:{icon:"iconTable"},NodeThematicBreak:{icon:"iconLine"},NodeVideo:{icon:"iconVideo"},NodeWidget:{icon:"iconBoth"}},dt=r=>{var s;const e=lt[r.type],t=ct[e];if(!t)return"";if(r.subtype){const n=(s=t.subtypes)==null?void 0:s[r.subtype];if(n)return n.icon}return t.icon};window.Lute.EscapeHTMLStr;const re=(r,e="join")=>{if(r.split(`
`).length<=1)return r;if(e==="join")return r.split(`
`).map(s=>s.trim()).join(" ");{let s=r.split(`
`).map(n=>n.trim()).filter(n=>n);return s.length>0?s[0]:""}},D=(r,e,t)=>{let s="";const n=(o,l)=>`[${o}](siyuan://blocks/${l})`,i=o=>{let l=Xe(o);return t!=null&&t.onlyDate?O("yyyy-MM-dd",l):t!=null&&t.onlyTime?O("HH:mm:ss",l):O("yyyy-MM-dd HH:mm:ss",l)},a=()=>{let o=r.hpath,l=o.lastIndexOf("/");return o.substring(l+1)};switch(e){case"type":const o=P[r.type]??r.type;s=n(o,r.id);break;case"id":s=n(r.id,r.id);break;case"root_id":r.hpath?s=n(a(),r.root_id):s=r.root_id;break;case"hpath":r.root_id?s=n(r.hpath,r.root_id):s=r.hpath;break;case"content":s=r.fcontent||r.content;break;case"box":s=ee(r.box).name;break;case"updated":case"created":s=i(r[e]);break;case"ial":let c=r.ial;c=c.replace("{:","").replace("}","").trim();let d={};c.split(" ").forEach(m=>{let[h,u]=m.split("=");u!=null&&u.startsWith('"')&&(u!=null&&u.endsWith('"'))&&(u=u.slice(1,-1)),d[h]=u}),s=JSON.stringify(d);break;case"block_id":case"def_block_id":case"def_block_parent_id":case"def_block_root_id":r[e]?s=n(r[e],r[e]):s=r[e];break;default:s=r[e];break}return s.toString()},T=(r,e)=>{r.innerHTML=`<span style="color: var(--b3-card-error-color);background-color: var(--b3-card-error-background);">${e}</span>`};class ut{constructor(e){p(this,"element");p(this,"dataList");p(this,"type","u");this.element=e.target,this.dataList=e.dataList,this.type=e.type??"u",this.render()}itemToString(e,t=0,s=1){var d;const n="    ".repeat(t),i=this.type==="u"?"*":`${s}.`,a=`${n}${i} `,o=" ".repeat(a.length),l=m=>{let h=m.split(`
`);return h.length<=1?m:h.map((u,f)=>f===0?u:`${o}${u}`).join(`
`)};if(typeof e=="string"||typeof e=="number"||!e.name)return[`${a}${l(e.toString())}`];const c=[`${a}${l(e.name.toString())}`];return(d=e.children)!=null&&d.length&&e.children.forEach((m,h)=>{c.push(...this.itemToString(m,t+1,h+1))}),c}render(){const e=G();let t=[];this.dataList.forEach((i,a)=>{t.push(...this.itemToString(i,0,a+1))});const s=t.join(`
`),n=e.Md2BlockDOM(s);this.element.innerHTML=`<div>${n}</div>`}}const oe=()=>j.defaultTableColumns.split(",").map(r=>r.trim());class ht{constructor(e){p(this,"element");p(this,"tableData");p(this,"center");p(this,"indices");p(this,"tdRenderer");var a;const t=this.adaptColumnInput(e);if(!t)return;const s=(o,l)=>e!=null&&e.renderer?e.renderer(o,l)??D(o,l):D(o,l),n=G();this.tdRenderer=o=>o.toLowerCase().startsWith("{@html")&&o.endsWith("}")?(o=o.slice(7,-1),o):n.InlineMd2BlockDOM(`${o}`);let i=[t.name];e.blocks.forEach(o=>{let l=t.key.map(c=>s(o,c)??"");i.push(l)}),this.element=e.target,this.center=(e==null?void 0:e.center)??!1,this.indices=(e==null?void 0:e.indices)??!1,this.indices?(this.tableData=i.map((o,l)=>[l,...o]),((a=this.tableData[0])==null?void 0:a.length)>1&&(this.tableData[0][0]="#")):this.tableData=i,this.render()}adaptColumnInput(e){const{cols:t,blocks:s}=e;let n=[],i=[];if(t===void 0)return n=this.fallbckColumns(s),i=n,{key:n,name:i};if(t===null){if(s.length==0)return n=this.fallbckColumns(s),i=n,{key:n,name:i};const a=s[0];return n=Object.keys(a),i=n,{key:n,name:i}}else if(Array.isArray(e.cols))n=[],e.cols.forEach((a,o)=>{if(typeof a=="string")n.push(a),i.push(a);else if(Object.keys(a).length===1)n.push(Object.keys(a)[0]),i.push(Object.values(a)[0]);else{T(this.element,"Invalid column definition");return}});else if(typeof e.cols=="object")n=Object.keys(e.cols),i=Object.values(e.cols);else{T(this.element,"Invalid column definition");return}return{key:n,name:i}}fallbckColumns(e){if(e.length===0)return oe();const t=e[0],s=Object.keys(t),n=oe().filter(i=>s.includes(i));return n.length===oe().length?n:s}render(){const e=G(),t=this.tableData,s=t[0].map(a=>`<th>${e.InlineMd2BlockDOM(`${a}`)}</th>`).join(""),n=t.slice(1).map(a=>`<tr>${a.map(l=>`<td>${this.tdRenderer(`${l}`)}</td>`).join("")}</tr>`).join(""),i=`
            <table class="query-table" style="${this.center?"margin: 0 auto;":""}">
                <thead>
                    <tr style="text-align: left;">${s}</tr>
                </thead>
                <tbody>${n}</tbody>
            </table>
        `;this.element.innerHTML=i}}class mt{constructor(e){p(this,"element");p(this,"blocks");p(this,"cardWidth");p(this,"cardHeight");p(this,"fontSize");this.element=e.target,this.blocks=e.blocks,!e.cardWidth&&e.width&&(e.cardWidth=e.width),!e.cardHeight&&e.height&&(e.cardHeight=e.height),this.cardWidth=e.cardWidth??"175px",this.cardHeight=e.cardHeight??this.cardWidth,this.fontSize=e.fontSize??"14px",this.render()}formatTimestamp(e){if(!e||e.length<14)return"";const t=e.substring(0,4),s=e.substring(4,6),n=e.substring(6,8),i=e.substring(8,10),a=e.substring(10,12);return`${t}-${s}-${n} ${i}:${a}`}render(){if(!this.blocks||this.blocks.length===0){T(this.element,"No blocks to display");return}const e=document.createElement("div");Object.assign(e.style,{display:"flex",flexWrap:"wrap",gap:"12px",justifyContent:"flex-start",padding:"8px"});const t=(s,n)=>(n=n??this.fontSize,`<svg style="width: ${n}; height: ${n};"><use href="#${s}"></use></svg>`);this.blocks.forEach(s=>{var u;const n=document.createElement("div");Object.assign(n.style,{width:this.cardWidth,height:this.cardHeight,fontSize:this.fontSize,border:"2px solid var(--b3-border-color)",borderRadius:"8px",boxShadow:"0 4px 8px var(--b3-theme-surface-light)",padding:"16px",transition:"transform 0.2s, box-shadow 0.2s",backgroundColor:"var(--b3-theme-background)",overflow:"hidden",position:"relative",display:"flex",flexDirection:"column"}),n.dataset.blockId=s.id;const i=document.createElement("div");Object.assign(i.style,{flexGrow:"1",display:"flex",flexDirection:"column",gap:"10px",overflow:"hidden"});const a=document.createElement("div");Object.assign(a.style,{flex:"1",fontWeight:"bold",fontSize:"1.15em",marginBottom:"4px",borderBottom:"1px solid var(--b3-border-color)",paddingBottom:"8px",color:"var(--b3-theme-primary)",overflow:"hidden",textOverflow:"ellipsis",cursor:"pointer",display:"inline-block"});const o=s.content||"(No content)";a.title=o;const l=dt(s);let c="";l&&(c=t(l)),a.innerHTML=`${c} ${o}`,a.classList.add("popover__block"),a.dataset.id=s.id,a.addEventListener("click",f=>{f.stopPropagation(),window.open(`siyuan://blocks/${s.id}`,"_blank")}),i.appendChild(a);const d=document.createElement("div");Object.assign(d.style,{display:"flex",flexDirection:"column",gap:"4px",fontSize:"0.95em",color:"var(--b3-theme-on-surface)",flex:"none"});const m=(f,g)=>{const y=document.createElement("div");Object.assign(y.style,{display:"flex",alignItems:"flex-start",gap:"6px",fontWeight:"500"});const x=document.createElement("span");if(x.style.display="inline-flex",x.innerHTML=t(f),y.appendChild(x),typeof g=="string"){const k=document.createElement("span");k.style.flex="1",k.style.lineHeight=`${this.fontSize}`,k.innerHTML=g,y.appendChild(k)}else g.style.lineHeight=`${this.fontSize}`,y.appendChild(g);return y};if(s.box||s.hpath){const f=s.box?(u=ee(s.box))==null?void 0:u.name:"",g=f?s.hpath?`[${f}]${s.hpath}`:f:s.hpath||"",y=m("iconFolder",g);y.style.alignItems="flex-start",y.lastElementChild.style.textWrap="initial",d.appendChild(y)}const h=document.createElement("div");Object.assign(h.style,{display:"flex",flexDirection:"column",gap:"1px"}),h.innerHTML=`<span>${this.formatTimestamp(s.created)}</span>
                <span>${this.formatTimestamp(s.updated)}</span>`,d.appendChild(m("iconClock",h)),i.appendChild(d),n.appendChild(i),e.appendChild(n)}),this.element.innerHTML="",this.element.appendChild(e)}}class ye{constructor(e,t=""){p(this,"element");p(this,"disposeCb",[]);p(this,"code");this.element=e,this.code=t}async checkMermaid(){if(window.mermaid)return;const e=w.Constants.PROTYLE_CDN;if(console.debug("Initializing mermaid..."),!await se(`${e}/js/mermaid/mermaid.min.js`,"protyleMermaidScript"))return;const s={securityLevel:"loose",altFontFamily:"sans-serif",fontFamily:"sans-serif",startOnLoad:!1,flowchart:{htmlLabels:!0,useMaxWidth:!0},sequence:{useMaxWidth:!0,diagramMarginX:8,diagramMarginY:8,boxMargin:8,showSequenceNumbers:!0},gantt:{leftPadding:75,rightPadding:20}};window.siyuan.config.appearance.mode===1&&(s.theme="dark"),window.mermaid.initialize(s)}async render(){await this.checkMermaid();const e="mermaid"+window.Lute.NewNodeID();try{const t=await window.mermaid.render(e,this.code);this.element.innerHTML=t.svg}catch(t){w.showMessage(exports.i18n.src_dataquery_componentsts.mermaid_render_failed,3e3,"error"),console.groupCollapsed("Mermaid failed to render code:"),console.warn(t),console.warn(this.code),console.groupEnd();const s=document.querySelector(`body>div#d${e}`);s&&(s.style.position="absolute",s.style.bottom="0",s.classList.add(_["remove-mermaid"]),s.style.opacity="0",s.style.transform="translateY(50px)",setTimeout(()=>{s.remove()},1e3)),T(this.element,"Failed to render mermaid, something wrong with mermaid code")}}dispose(){this.disposeCb.forEach(e=>e()),this.disposeCb=[]}}class pt extends ye{constructor(t){super(t.target,"");p(this,"type");p(this,"rootNode");p(this,"blocks");p(this,"blockSet");p(this,"renderer");p(this,"direction");p(this,"DEFAULT_RENDERER",t=>{if(typeof t=="string")return re(t);if((t==null?void 0:t.type)==="query_embed")return"Query Embed";if((t==null?void 0:t.type)==="c")return"Code Block";const s=t.name||(t==null?void 0:t.fcontent)||(t==null?void 0:t.content)||(t==null?void 0:t.id)||"empty";let n=re(s);return n=window.Lute.EscapeHTMLStr(n),n});this.type=t.type,this.rootNode=t.rootNode,this.renderer=t.renderer,this.direction=t.flowchart??"LR",this.checkRelationTree().then(()=>{this.render()})}async render(){let t=!1;this.type==="flowchart"?t=this.buildFlowchartCode():this.type==="mindmap"&&(t=this.buildMindmapCode()),t&&(await super.render(),this.postProcess())}async checkRelationTree(){this.blocks={};const t=s=>{var n;s.id&&N(s.id)&&(this.blocks[s.id]=s),(n=s.children)==null||n.forEach(t)};t(this.rootNode)}buildFlowchartCode(){this.code=`flowchart ${this.direction}
`;const t=[],s=n=>{var i,a;if(n.id){const o=this.blocks[n.id];let l=((i=this.renderer)==null?void 0:i.call(this,o))||this.DEFAULT_RENDERER(o);t.push(`${n.id}["${l??n.id}"]`),t.push(`click ${n.id} "siyuan://blocks/${o.id}"`)}else if(n.name){let o=n.content||n.name;t.push(`${n.name}["${o}"]`)}(a=n.children)==null||a.forEach(o=>{const l=n.id||n.name,c=o.id||o.name;l&&c&&t.push(`${l} --> ${c}`),s(o)})};return s(this.rootNode),this.code+=t.map(n=>`    ${n}`).join(`
`),!0}buildMindmapCode(){this.code=`mindmap
`;const t=[],s=(n,i=1)=>{var a,o;if(n.id){const l=this.blocks[n.id],c=((a=this.renderer)==null?void 0:a.call(this,l))||this.DEFAULT_RENDERER(l);t.push(`${"    ".repeat(i)}${c}`),t.push(`${"    ".repeat(i)}:::data-id-${n.id}`)}else if(n.name){let l=n.content||n.name;t.push(`${"    ".repeat(i)}${l}`)}(o=n.children)==null||o.forEach(l=>s(l,i+1))};return s(this.rootNode),this.code+=t.join(`
`),!0}postProcess(){if(this.type==="mindmap"){const t=n=>{const i=n.closest(".mindmap-node");if(!i)return;let a=null;if(i.classList.forEach(o=>{o=o.trim(),o.startsWith("data-id-")&&(a=o.split("data-id-")[1])}),!(!a||!N(a)))return i.classList.add("popover__block"),i.dataset.id=a,a},s=n=>{const a=n.target.closest(`.${_["mindmap-node-siyuan"]}`);if(!a)return;const o=a.dataset.id;!o||!N(o)||W(o)};this.element.addEventListener("click",s),this.element.querySelectorAll(".mindmap-node").forEach(n=>{const i=t(n);i&&(n.dataset.id=i,n.classList.add(_["mindmap-node-siyuan"]))}),this.disposeCb.push(()=>{this.element.removeEventListener("click",s)})}else this.type==="flowchart"&&this.element.querySelectorAll("svg g.nodes g.node.clickable").forEach(t=>{var i;const s=t.parentElement;if(((i=s==null?void 0:s.tagName)==null?void 0:i.toLocaleUpperCase())!=="A")return;s.classList.add("popover__block");let n=t.id;n=n.replace("flowchart-",""),n=n.split("-").slice(0,2).join("-"),s.dataset.id=n})}}const ie=class ie extends ye{constructor(t){super(t.target,"");p(this,"groupedBlocks");p(this,"clipStr");p(this,"priorityMapper");p(this,"width");p(this,"center");p(this,"DEFAULT_RENDERER",t=>{let s="";if(typeof t=="string")return re(t);if((t==null?void 0:t.type)==="query_embed")return"Query Embed";if((t==null?void 0:t.type)==="c")return"Code Block";t.type==="h"?t.markdown.replace(/^(#+)/,(o,l)=>`H${l.length} Text`):s=t.name||t.fcontent||(t==null?void 0:t.markdown)||(t==null?void 0:t.id)||"empty";const n=/!\[([^\]]*)\]\(([^)\s"]+)(?:\s+"([^"]*)")?\)/g;s=s.replace(n,(a,o,l,c)=>c?`Image: [${c}]`:"Image");let i=re(s,"first");return i=i.replace(/siyuan:\/\/blocks\/\d{14}-[a-z0-9]{7}/g,""),i=i.replaceAll(/[{(\[]/g,"").replaceAll(/[})\]]/g,""),i===""&&(i="Empty"),i});this.groupedBlocks=t.groupedBlocks,this.clipStr=t.clip??50,this.priorityMapper=t.priority,this.width=t.width,this.render(),this.center=t.center??!0}async render(){this.buildKanbanCode(),await super.render(),this.postProcess()}clip(t,s){return s<=0?t:t.length>s-2?t.slice(0,s)+"...":t}assignPriority(t){return this.priorityMapper?this.priorityMapper(t):null}buildKanbanCode(){let t=`${ie.PREFIX}
kanban
`;for(const s in this.groupedBlocks){const n=this.groupedBlocks[s];t+=`    ${s}
`,n.forEach(i=>{let a=this.DEFAULT_RENDERER(i);a=this.clip(a,this.clipStr);let o=this.assignPriority(i),l="";o&&(l=`@{ priority: '${o}' }`),t+=`        ${i.id}[${a}]${l}
`})}this.code=t}postProcess(){const t=n=>{const a=n.target.closest("g.node");if(!a)return;const o=a.dataset.id;!o||!N(o)||W(o)};this.element.querySelectorAll("g.items>g.node").forEach(n=>{let i=n.id;!i||!N(i)||(n.setAttribute("data-id",i),n.classList.add("popover__block"))}),this.element.addEventListener("click",t),this.disposeCb.push(()=>{this.element.removeEventListener("click",t)});const s=this.element.querySelector("svg");s&&(s.style.maxWidth="unset",s.classList.add("query-view__mkanban")),this.width&&(typeof this.width=="string"?s.setAttribute("width",this.width):typeof this.width=="number"&&s.setAttribute("width",`${this.width}px`))}};p(ie,"PREFIX",`
---
config:
    kanban:
        ticketBaseUrl: 'siyuan://blocks/#TICKET#'
---
`.trim());let le=ie;class ft{constructor(e){p(this,"element");p(this,"blocks");p(this,"limit");p(this,"breadcrumb");p(this,"embedBlockID");p(this,"columns");p(this,"zoom");this.element=e.target,this.blocks=e.blocks,this.limit=e.limit,this.breadcrumb=e.breadcrumb??!0,this.embedBlockID=e.embedBlockID,this.columns=e.columns??1,this.zoom=e.zoom??1,this.render()}async render(){const e=document.createDocumentFragment(),t=await E("/api/search/getEmbedBlock",{embedBlockID:this.embedBlockID,includeIDs:this.blocks.map(s=>s.id),headingMode:0,breadcrumb:this.breadcrumb});if(!t.blocks||t.blocks.length===0){T(this.element,"Failed to get embed blocks, check console for details");return}t.blocks.forEach(s=>{var l;const n=document.createElement("div");if(n.innerHTML=s.block.content,this.limit){if(n.childNodes.length===1){const c=n.childNodes[0];if(c.nodeType===Node.ELEMENT_NODE){const d=Array.from(c.children).filter(m=>m.tagName.toLowerCase()==="div"&&m.hasAttribute("data-node-id"));if(d.length>this.limit){d.forEach((f,g)=>{g>=this.limit&&(f.style.display="none",f.classList.add("embed-hidden-item"))});const h=`<svg class="popover__block" data-id="${s.block.id}"><use xlink:href="#iconMore"></use></svg>`,u=document.createElement("div");u.innerHTML=h,u.className=_["embed-more-svg"]+" embed-more-icon",u.dataset.state="collapsed",c.appendChild(u)}}}else if(n.childNodes.length>this.limit){Array.from(n.children).forEach(h=>{parseInt(h.dataset.nodeIndex)>this.limit&&(h.style.display="none",h.classList.add("embed-hidden-item"))});const d=`<svg class="popover__block" data-id="${s.block.id}"><use xlink:href="#iconMore"></use></svg>`,m=document.createElement("div");m.innerHTML=d,m.className=_["embed-more-svg"]+" embed-more-icon",m.dataset.state="collapsed",n.appendChild(m)}}const i=document.createElement("div");i.className=_["embed-container"],i.dataset.nodeId=s.block.id,i.append(...n.childNodes),this.limit&&(i.dataset.limit=this.limit.toString());const a="iconFocus",o=document.createElement("a");if(o.className=_["embed-jump-icon"],o.innerHTML=`<svg class="popover__block" data-id="${s.block.id}"><use xlink:href="#${a}"></use></svg>`,o.href=`siyuan://blocks/${s.block.id}`,i.appendChild(o),this.breadcrumb&&((l=s.blockPaths)==null?void 0:l.length)>0){const c=this.newBreadcrumb(s.blockPaths[0].id,s.blockPaths[0].name);i.insertBefore(c,i.firstChild)}e.appendChild(i)}),e.querySelectorAll("[contenteditable]").forEach(s=>{s.setAttribute("contenteditable","false")}),this.element.appendChild(e),this.element.onclick=s=>{s.stopPropagation();const i=s.target.closest(".embed-more-icon");if(!i)return;const a=i.dataset.state==="collapsed",o=i.closest("."+_["embed-container"])||i.parentElement.closest("div");o&&o.querySelectorAll(".embed-hidden-item").forEach(l=>{l.style.display=a?"":"none"}),i.querySelector("svg").innerHTML=`<use xlink:href="#icon${a?"Left":"More"}"></use>`,i.dataset.state=a?"expanded":"collapsed"},this.columns>1&&Object.assign(this.element.style,{columnCount:this.columns.toString(),columnGap:"0px"}),this.element.style.zoom=`${this.zoom}`}newBreadcrumb(e,t){const s=`
        <div contenteditable="false" class="protyle-breadcrumb__bar protyle-breadcrumb__bar--nowrap"><span class="protyle-breadcrumb__item protyle-breadcrumb__item--active" data-id="${e}">
    <svg class="popover__block" data-id="${e}"><use xlink:href="#iconFile"></use></svg>
            <span class="protyle-breadcrumb__text" title="${t}">${t}</span>
        </span></div>
        `,n=document.createElement("div");return Object.assign(n.style,{fontSize:"0.85rem"}),n.innerHTML=s,n}}class yt{constructor(e){p(this,"element");p(this,"width");p(this,"height");p(this,"option");p(this,"chart");p(this,"eventHandlers",new Map);p(this,"dispose",()=>{});this.element=e.target,this.width=e.width,this.height=e.height,this.option=e.option,e.events&&Object.entries(e.events).forEach(([t,s])=>{this.eventHandlers.set(t,s)}),this.checkEcharts().then(t=>{t?this.render():T(this.element,"Failed to initialize echarts.")})}async render(){try{this.element.style.height||(this.element.style.height=this.height??"300px"),this.element.style.width||(this.element.style.width=this.width??"100%"),this.element.style.padding="0px",this.chart=window.echarts.init(this.element,window.siyuan.config.appearance.mode===1?"dark":void 0,{renderer:j.echartsRenderer}),this.option.grid||(this.option.grid={containLabel:!0}),this.chart.setOption(this.option),this.eventHandlers.forEach((t,s)=>{this.chart.on(s,t)});const e=()=>{var t;return(t=this.chart)==null?void 0:t.resize()};window.addEventListener("resize",e),this.dispose=()=>{var t;console.debug("Echarts dispose"),this.eventHandlers.forEach((s,n)=>{var i;(i=this.chart)==null||i.off(n,s)}),this.eventHandlers.clear(),window.removeEventListener("resize",e),(t=this.chart)==null||t.dispose()}}catch(e){console.error("Echarts render error:",e),T(this.element,"Failed to render echarts, check console for details")}}async checkEcharts(){if(window.echarts)return!0;const e=w.Constants.PROTYLE_CDN;return console.debug("Initializing echarts..."),await se(`${e}/js/echarts/echarts.min.js`,"protyleEchartsScript")?(await se(`${e}/js/echarts/echarts-gl.min.js`,"protyleEchartsGLScript"),!0):!1}updateOption(e,t=!1){this.chart&&this.chart.setOption(e,t)}resize(){var e;(e=this.chart)==null||e.resize()}on(e,t){var s;this.eventHandlers.set(e,t),(s=this.chart)==null||s.on(e,t)}off(e){var s;const t=this.eventHandlers.get(e);t&&((s=this.chart)==null||s.off(e,t),this.eventHandlers.delete(e))}}class ge{constructor(e){p(this,"element");p(this,"lute");this.element=e.target,this.lute=G(),this.render(e.markdown)}render(e){this.element.innerHTML=this.lute.Md2BlockDOM(e);let t=Array.from(this.element.querySelectorAll('[data-type="inline-math"]')),s=Array.from(this.element.querySelectorAll('[data-type="NodeMathBlock"]')),n=[...t,...s];if(n.length>0){const a=()=>{n.forEach(o=>{ge.renderMathBlock(o)})};window.katex?a():rt().then(a).then(()=>{this.element.querySelectorAll('[contenteditable="true"]').forEach(l=>{l.setAttribute("contenteditable","false")})})}this.element.querySelectorAll('[contenteditable="true"]').forEach(a=>{a.setAttribute("contenteditable","false")}),this.element.classList.add(_["markdown-component"])}static renderMathBlock(e){try{let t=e.dataset.content||"";if(!t.trim())return;t=window.Lute.UnEscapeHTMLStr(t);const s=e.tagName.toUpperCase()==="DIV",n=window.katex.renderToString(t,{throwOnError:!1,displayMode:s,strict:i=>i==="unicodeTextInMathMode"?"ignore":"warn",trust:!0});e.innerHTML=n,e.style.pointerEvents="none",e.style.cursor="default",e.style.userSelect="text",s&&e.classList.add(_["katex-center-display"])}catch(t){console.error("Error rendering math formula:",t),e.innerHTML=`<span style="color: red;">Error rendering formula: ${t.message}</span>`}}}const B=new Map,gt=(r,e)=>{B.has(r)||B.set(r,[]);const t=B.get(r),s=t.findIndex(n=>{const i=n.deref();return i&&i.embed_id===e.embed_id});s!==-1?t[s]=new WeakRef(e):t.push(new WeakRef(e))},De=async(r,e)=>{console.debug(`[finalize.ts] Finalize dataView@${r.embed_id} under doc@${e}`),await r.flushStateIntoBlockAttr(),r.dispose(),r.removeFromSessionStorage()},Me=({detail:r})=>{const e=r.protyle.block.rootID;if(!B.has(e))return;const t=B.get(e);console.group(`[finalize.ts] onProtyleDestroyed for doc@${e} (${t.length} views)`),t.forEach(s=>{const n=s.deref();n&&De(n,e)}),console.groupEnd(),B.delete(e)},we=()=>{console.group(`[finalize.ts] finalizeAllDataviews (${B.size} views)`),B.forEach((r,e)=>{r.forEach(async t=>{const s=t.deref();s&&await De(s,e)})}),console.groupEnd()},V=class V{constructor(e){p(this,"stateMap",new Map);p(this,"blockId");p(this,"node");p(this,"sessionStorageKey",()=>`dv-state@${this.blockId}`);this.blockId=e.dataset.nodeId,this.node=new WeakRef(e),this.restoreState()}getState(e){return this.stateMap.get(e)}setState(e,t){this.stateMap.set(e,t)}restoreState(){var t;const e=sessionStorage.getItem(this.sessionStorageKey());e?this.stateMap=new Map(Object.entries(JSON.parse(e))):Array.from(((t=this.node.deref())==null?void 0:t.attributes)??[]).filter(n=>n.name.startsWith(V.customStateKey(""))).forEach(n=>{this.stateMap.set(n.name.replace(V.customStateKey(""),""),JSON.parse(n.value))})}async saveToBlockAttrs(){const e={};this.stateMap.forEach((t,s)=>{e[V.customStateKey(s)]=JSON.stringify(t)}),console.debug("saveToBlockAttrs",this.blockId,e),await fe(this.blockId,e)}get hasState(){return this.stateMap.size>0}saveToSessionStorage(){if(!this.hasState)return;const e={};this.stateMap.forEach((t,s)=>{e[s]=t}),sessionStorage.setItem(this.sessionStorageKey(),JSON.stringify(e))}removeFromSessionStorage(){sessionStorage.removeItem(this.sessionStorageKey())}useState(e,t){this.stateMap.has(e)||this.setState(e,t);const s=[],n=()=>this.getState(e),i=o=>{this.setState(e,o),this.saveToSessionStorage(),s.forEach(l=>l(o,this.getState(e)))},a=o=>(o!==void 0&&i(o),n());return Object.defineProperty(a,"value",{get:n,set:i}),Object.defineProperty(a,"effect",{value:o=>{s.push(o)}}),Object.defineProperty(a,"derived",{value:o=>()=>o(a())}),a}};p(V,"customStateKey",e=>`custom-dv-state-${e}`);let ce=V;const K=r=>getComputedStyle(document.documentElement).getPropertyValue(r),S=(r="div")=>{let e=document.createElement(r);e.classList.add(_["data-view-component"],"protyle-custom");const t=window.Lute.NewNodeID();return e.dataset.id=t,e},wt=r=>r.charAt(0).toUpperCase()+r.slice(1),ae=class ae extends ce{constructor(t,s,n){super(s);p(this,"protyle");p(this,"thisEmbedNode");p(this,"top");p(this,"lute");p(this,"disposers",{});p(this,"ROOT_ID");p(this,"EMBED_BLOCK_ID");p(this,"_element");p(this,"observer");p(this,"disposed",!1);p(this,"adddisposer",this.addDisposer);p(this,"addView",this.addElement);p(this,"addelement",this.addElement);p(this,"addele",this.addElement);p(this,"removeview",this.removeView);p(this,"replaceview",this.replaceView);this.protyle=t,this.thisEmbedNode=s,this.top=n,this._element=document.createElement("div"),this.lute=G(),this._element.classList.add(_["data-query-embed"],"protyle-custom"),this._element.dataset.id=window.Lute.NewNodeID(),this.thisEmbedNode.lastElementChild.insertAdjacentElement("beforebegin",this._element),this.ROOT_ID=this.protyle.block.rootID,this.EMBED_BLOCK_ID=s.dataset.nodeId,this.register(this.markdown,{aliases:["md"]}),this.register(this.details,{aliases:["Details","Detail"]}),this.register(this.list,{aliases:["BlockList"]}),this.register(this.table,{aliases:["BlockTable"]}),this.register(this.cards,{aliases:["card"]}),this.register(this.columns,{aliases:["Cols"]}),this.register(this.rows),this.register(this.mermaid,{aliases:["Mermaid"]}),this.register(this.mermaidRelation),this.register(this.mermaidFlowchart,{aliases:["mFlowchart"]}),this.register(this.mermaidMindmap,{aliases:["mMindmap"]}),this.register(this.mermaidKanban,{aliases:["mKanban"]}),this.register(this.embed),this.register(this.echarts),this.register(this.echartsLine,{aliases:["eLine"]}),this.register(this.echartsBar,{aliases:["eBar"]}),this.register(this.echartsTree,{aliases:["eTree"]}),this.register(this.echartsGraph,{aliases:["eGraph"]}),this.register(this.details,{aliases:["Detail"]}),this.registerCustomViews()}register(t,s={}){const n=s.name??t.name,i=new Set(s.aliases??[]),a=[];if(ae.PROHIBIT_METHOD_NAMES.includes(n)){console.warn(`Method name ${n} is prohibited, please use another name.`);return}i.add(n);for(const c of i)a.push(wt(c)),a.push(c.toLowerCase());a.forEach(c=>i.add(c));const o=Array.from(i);o.forEach(c=>{this[c]=t.bind(this),this[c.toLowerCase()]=t.bind(this)});const l=(...c)=>{const d=t.apply(this,c);return this.addElement(d)};this["add"+n]=l,o.forEach(c=>{const d="add"+c;this[d]=l,this[d.toLowerCase()]=l})}registerCustomViews(){const t=xt();if(!t)return;const s=(n,i)=>(...a)=>{const{render:o,dispose:l}=i(this),c=S();if(!o)T(c,`Custom view ${n} should have an init method`);else{const d=o(c,...a);d&&(d instanceof Promise?d.then(m=>m&&c.append(m)).catch(m=>{const h=document.createElement("span");T(h,m.message),c.append(h)}):d&&c.append(d))}return l&&this.addDisposer(()=>l(),c.dataset.id),c};Object.entries(t).forEach(([n,i])=>{const a=n,{use:o,alias:l}=i;this.register(s(a,o),{name:a,aliases:l})})}get root_id(){return this.ROOT_ID}get embed_id(){return this.EMBED_BLOCK_ID}dispose(){if(!this.disposed){this.disposed=!0;try{for(let t in this.disposers){const s=this.disposers[t];s()}}catch(t){console.error("Error during dispose:",t)}finally{this.disposers={},this.cleanup()}}}async flushStateIntoBlockAttr(){this.hasState&&(console.debug(`Flushing state into block attrs for ${this.root_id}::${this.embed_id}`),await this.saveToBlockAttrs())}repaint(){const t=this.thisEmbedNode.querySelector("div.protyle-icons > span.protyle-action__reload");t&&(this.dispose(),t.click())}useState(t,s){return super.useState(t,s)}cleanup(){this.protyle=null,this.thisEmbedNode=null,this._element=null,this.lute=null,this.observer=null}addDisposer(t,s){if(s=s??window.Lute.NewNodeID(),this.disposers[s]){const n=this.disposers[s];n(),console.warn(`WARNING! Disposer with key@${s} has already registered!`)}this.disposers[s]=t}view(t){let s;if(typeof t=="string"){s=S();const n=`<div class="data-view-element" style="display: contents;">${t}</div>`;s.innerHTML=n}else t instanceof Element&&(this.isValidViewContainer(t)?s=t:(s=S(),s.appendChild(t)));return s}addElement(t,s){let n=this.view(t);if(this._element.append(n),s){const i=n.dataset.id;this.addDisposer(s,i)}return n}isValidViewContainer(t){if(!t.classList.contains(_["data-view-component"]))return!1;const s=t.dataset.id;return!(!s||!N(s))}removeView(t,s){if(!t)return!1;const n=`.${_["data-view-component"]}[data-id="${t}"]`,i=this._element.querySelector(n);if(i&&this.isValidViewContainer(i)){const a=this.disposers[t];return a&&(a(),delete this.disposers[t]),s==null||s(i),i.remove(),!0}return!1}replaceView(t,s,n){if(!t)return null;if(s=this.view(s),!this.removeView(t,o=>{o.insertAdjacentElement("beforebegin",s)})){T(s,`Failed to replace view with ID=${t}, please check if anything wrong.`),this._element.append(s);return}delete this.disposers[t];let a=s.dataset.id;if(this.disposers[a]&&(this.disposers[t]=this.disposers[a],delete this.disposers[a]),n){const o=this.disposers[t];o?this.disposers[t]=()=>{o(),n()}:this.disposers[t]=n}return s.dataset.id=t,s}markdown(t){let s=S();return new ge({target:s,markdown:t}),s}details(t,s){const n=S("details");return n.innerHTML=`<summary>${t}</summary>${typeof s=="string"?s:""}`,s instanceof HTMLElement&&n.appendChild(s),n.open=!0,n}list(t,s={}){let n=d=>{if(typeof d=="object")if(d.id&&N(d.id)){if(d.type==="c"||d.type==="query_embed")return`[${P[d.type]}](siyuan://blocks/${d.id})`;let m=(d==null?void 0:d.fcontent)||d.content||"";return m!==""?`[${m}](siyuan://blocks/${d.id})`:`[${exports.i18n.src_core_dataviewts.blank}${P[d.type]}](siyuan://blocks/${d.id})`}else return JSON.stringify(d);return d.toString()};const i=d=>{var m;return((m=s==null?void 0:s.renderer)==null?void 0:m.call(s,d,n))??n(d)},a=d=>{var m;return{name:i(d),children:(m=d==null?void 0:d.children)==null?void 0:m.map(a)}},o=t.map(a);let l=S();const c=new ut({target:l,dataList:o,type:s.type??"u"});return s.columns&&(c.element.style.columnCount=s.columns.toString()),l}table(t,s){let n=S();s=s??{};const i=new ht({target:n,blocks:t,cols:s==null?void 0:s.cols,center:s.center??!1,indices:s.index??!1,renderer:s.renderer});return s.fullwidth&&(i.element.querySelector("table").style.width="100%"),n.style.overflowX="auto",n}cards(t,s){const n=S();return new mt({target:n,blocks:t,...s}),n.style.overflowX="auto",n}columns(t,s={}){const n=S(),i=c=>typeof c=="number"?`${c}px`:c,a=document.createElement("div");a.classList.add(_.columns),s!=null&&s.gap&&a.style.setProperty("--col-gap",s.gap),s!=null&&s.minWidth&&a.style.setProperty("--col-min-width",i(s.minWidth));const o=s.flex??Array(t.length).fill(1),l=(c,d)=>(c.classList.add(_.column),o[d]!==1&&a.style.setProperty("--flex-grow",o[d]),c);return t.forEach((c,d)=>a.append(l(c,d))),n.append(a),n.style.overflowX="auto",n}rows(t,s={}){const n=S(),i=document.createElement("div");i.classList.add(_.rows),s!=null&&s.gap&&i.style.setProperty("--row-gap",s.gap);const a=l=>typeof l=="number"?`${l}px`:l;s!=null&&s.maxHeight&&i.style.setProperty("max-height",a(s.maxHeight));const o=(l,c)=>{var d;return l.classList.add(_.row),(d=s==null?void 0:s.flex)!=null&&d[c]&&l.style.setProperty("--flex-grow",s.flex[c]),l};return t.forEach((l,c)=>i.append(o(l,c))),n.appendChild(i),n}mermaid(t){let s=S();const n=new ye(s,t);return n.render(),this.addDisposer(()=>n.dispose(),s.dataset.id),s}mermaidRelation(t,s={}){let n=S();if(!t.id){const o=Object.entries(t).map(([l,c])=>({name:l,children:c}));o.length===1?t=o[0]:t={name:"Root",children:o}}const i=new pt({target:n,type:s.type??"flowchart",rootNode:t,renderer:s.renderer,flowchart:s.flowchart??"LR"});return this.addDisposer(()=>i.dispose(),n.dataset.id),n}mermaidFlowchart(t,s={}){return this.mermaidRelation(t,{...s,type:"flowchart"})}mermaidMindmap(t,s={}){return this.mermaidRelation(t,{...s,type:"mindmap"})}mermaidKanban(t,s){let n=S();Object.assign(n.style,{"overflow-x":"auto"});const i=new le({target:n,groupedBlocks:t,...s});return this.addDisposer(()=>i.dispose(),n.dataset.id),n}embed(t,s){const n=S();return Array.isArray(t)||(t=[t]),new ft({target:n,blocks:t,embedBlockID:this.EMBED_BLOCK_ID,...s}),n}echarts(t,s={}){const n=S(),i=[K("--b3-theme-primary"),"#5470c6","#91cc75","#fac858","#ee6666","#73c0de","#3ba272","#fc8452","#9a60b4","#ea7ccc"];t.color=t.color??i;const a=new yt({target:n,option:t,...s});return this.addDisposer(()=>a.dispose(),n.dataset.id),n}echartsLine(t,s,n={}){const i=l=>n.seriesOption===void 0?{}:Array.isArray(n.seriesOption)?n.seriesOption[l??0]:n.seriesOption,a=Array.isArray(s[0])?s.map((l,c)=>{var d;return{name:((d=n.legends)==null?void 0:d[c])??`Series ${c+1}`,type:"line",data:l,...i(c)}}):[{type:"line",data:s,...i()}];let o={title:n.title?{text:n.title}:void 0,tooltip:{trigger:"axis"},xAxis:{type:"category",data:t,name:n.xlabel},yAxis:{type:"value",name:n.ylabel},series:a};return o=A(o,n.echartsOption),this.echarts(o,{height:n.height,width:n.width})}echartsBar(t,s,n={}){const i=l=>n.seriesOption===void 0?{}:Array.isArray(n.seriesOption)?n.seriesOption[l??0]:n.seriesOption,a=Array.isArray(s[0])?s.map((l,c)=>{var d;return{name:((d=n.legends)==null?void 0:d[c])??"",type:"bar",data:l,stack:n.stack?"total":void 0,...i(c)}}):[{type:"bar",data:s,...i()}];let o={title:n.title?{text:n.title}:void 0,tooltip:{trigger:"axis"},xAxis:{type:"category",data:t,name:n.xlabel},yAxis:{type:"value",name:n.ylabel},series:a};return o=A(o,n.echartsOption),this.echarts(o,{height:n.height,width:n.width})}echartsTree(t,s={}){const n=h=>typeof h=="string"?h:h.name||h.fcontent||h.content||h.id,i=h=>{if(typeof h=="string")return h;const u={...h};return u.children&&(u.children=u.children.length),u},a=h=>{if(h.id&&h.type&&h.hpath){const u=h.box?globalThis.Query.Utils.boxname(h.box):"";return`<ul style="list-style-type: none; margin: 0; padding: 0;">
                <li class="block-id popover__block" data-id="${h.id}">
                    <a href="siyuan://blocks/${h.id}">${h.id}</a>
                </li>
                <li class="block-type">${P[h.type]??h.type}</li>
                <li class="block-hpath">${u?`[${u}] `:""}${h.hpath}</li>
                </ul>`}else if(h.value)return h.value;return JSON.stringify(h)},o=h=>{let u={id:h.id,name:n(h),value:i(h),children:(h.children||[]).map(o)};if(s.nodeRenderer){let f=s.nodeRenderer(u);u={...u,...f}}return u},c=[((h,u)=>{const f=o(h);let g={type:"tree",name:"Series 0",roam:s.roam??!1,data:[f],orient:s.orient||"TB",layout:"orthogonal",symbolSize:s.symbolSize??14,initialTreeDepth:-1,lineStyle:{curveness:.5,width:2.5,color:K("--b3-theme-primary-light")},label:{position:s.orient==="LR"?"right":"top",rotate:s.orient==="LR"?0:void 0,verticalAlign:"middle",fontSize:s.labelFontSize??16}};return A(g,s.seriesOption)})(t)];let d={title:s.title?{text:s.title}:void 0,tooltip:{trigger:"item",enterable:!0,alwaysShowContent:!0,formatter:h=>s.tooltipFormatter?s.tooltipFormatter(h.value):a(h.value)??h.name},series:c};d=A(d,s.echartsOption);const m={click:h=>{var y;const u=h.value,f=(y=h.event)==null?void 0:y.event,g=f.ctrlKey||f.metaKey;u.id&&N(u.id)&&g&&W(u.id)}};return this.echarts(d,{height:s.height,width:s.width,events:m})}echartsGraph(t,s,n={}){const i=u=>typeof u=="string"?u:u.name||u.fcontent||u.content||u.id,a=u=>{let f=JSON.parse(u);if(f.id&&f.type&&f.hpath){const g=f.box?globalThis.Query.Utils.boxname(f.box):"";return`<ul style="list-style-type: none; margin: 0; padding: 0;">
                <li class="block-id popover__block" data-id="${f.id}">
                    <a href="siyuan://blocks/${f.id}">${f.id}</a>
                </li>
                <li class="block-type">${P[f.type]??f.type}</li>
                <li class="block-hpath">${g?`[${g}] `:""}${f.hpath}</li>
                </ul>`}else if(f.value)return f.value;return u},o=t.map(u=>{let f={name:i(u),value:(u==null?void 0:u.value)??JSON.stringify({id:u.id,name:u.name,type:u.type,hpath:u.hpath,box:u.box})};if(u={...u,...f},n.nodeRenderer){let g=n.nodeRenderer(u);u={...u,...g}}return u}),l=[],c={type:"solid",symbol:["none","arrow"],symbolSize:[10,15],color:K("--b3-theme-primary-light"),width:2.5};for(const u of s){const f=u.source,g=u.target;if(delete u.source,delete u.target,Array.isArray(g))for(const y of g)l.push({source:f,target:y,lineStyle:c,...u});else l.push({source:f,target:g,lineStyle:c,...u})}let d={type:"graph",layout:n.layout??"force",data:o,links:l,roam:n.roam??!1,symbolSize:n.symbolSize??14,label:{show:!0,position:"bottom",fontSize:n.labelFontSize??16},emphasis:{focus:"adjacency",itemStyle:{borderWidth:2,borderColor:K("--b3-theme-primary"),shadowBlur:10,shadowColor:K("--b3-theme-primary-lighter")},lineStyle:{width:4},label:{fontSize:(n.labelFontSize??16)+2}},edgeSymbol:["none","arrow"],edgeSymbolSize:[4,10],force:{repulsion:200,gravity:.1,edgeLength:100,layoutAnimation:!1}};d=A(d,n.seriesOption);let m={title:n.title?{text:n.title}:void 0,tooltip:{trigger:"item",enterable:!0,alwaysShowContent:!0,formatter:u=>n.tooltipFormatter?n.tooltipFormatter(u.value):a(u.value)??u.name},animationDurationUpdate:300,animationEasingUpdate:"linear",series:[d]};m=A(m,n.echartsOption);const h={click:u=>{var x;const f=u.value,g=(x=u.event)==null?void 0:x.event;if(g.ctrlKey||g.metaKey){let k=JSON.parse(f);k.id&&N(k.id)&&W(k.id)}}};return this.echarts(m,{height:n.height,width:n.width,events:h})}render(){const t=this.thisEmbedNode.querySelector(".fn__rotate");t&&t.classList.remove("fn__rotate"),this._element.setAttribute("contenteditable","false"),this.top&&(this.protyle.contentElement.scrollTop=this.top),this._element.querySelectorAll('[contenteditable="true"]').forEach(l=>{l.setAttribute("contenteditable","false")}),this.thisEmbedNode.style.height="";let n=this.lute.BlockDOM2Content(this._element.innerText).replaceAll(`
`," ");w.fetchSyncPost("/api/search/updateEmbedBlock",{id:this.thisEmbedNode.getAttribute("data-node-id"),content:n});const i=l=>{l.stopImmediatePropagation()},a=void 0,o=["compositionstart","compositionend","mousedown","mouseup","keydown","keyup","input","copy","cut","paste"];o.forEach(l=>{this._element.addEventListener(l,i,a)}),this._element.onclick=l=>{const c=l.target;if(c.tagName==="SPAN"){if(c.dataset.type==="a"||c.dataset.type.split(" ").includes("a")){if(c.dataset.href)return}else if(c.dataset.type==="block-ref"&&c.dataset.id)return}l.stopImmediatePropagation(),window.getSelection().toString().length===0&&l.target.tagName},this.protyle.element.addEventListener("keydown",_e,!0),this.addDisposer(()=>{this.protyle.element.removeEventListener("keydown",_e,!0),o.forEach(l=>{this._element.removeEventListener(l,i,a)}),this._element.onclick=null,this.thisEmbedNode=null,this._element=null,this.protyle=null,this.observer=null}),gt(this.ROOT_ID,this),this.registerInternalGC()}registerInternalGC(){this.addDisposer(()=>{console.debug("DataView dispose:",this.EMBED_BLOCK_ID),this.observer&&(this.observer.disconnect(),this.observer=null)}),this.observer=new MutationObserver(t=>{t.forEach(s=>{var n,i;s.type==="childList"?s.removedNodes.forEach(a=>{a instanceof Element&&a.classList.contains(_["data-query-embed"])&&this.dispose()}):s.type==="attributes"&&s.attributeName==="style"&&(i=(n=this.thisEmbedNode)==null?void 0:n.style)!=null&&i.height&&(this.thisEmbedNode.style.height="")})}),this.observer.observe(this.thisEmbedNode,{childList:!0,subtree:!1,attributes:!0,attributeFilter:["style"]})}};p(ae,"PROHIBIT_METHOD_NAMES",["register","element","ele","render"]);let ne=ae;const bt=`.${_["data-query-embed"]}`;function _e(r){const e=document.getSelection();if(!e||e.rangeCount===0)return;e.getRangeAt(0).startContainer.parentElement.closest(bt)&&r.stopPropagation()}const _t=ne.PROHIBIT_METHOD_NAMES,kt=`
/**
This script is used for sy-query-view plugin to define user's customized view components. Type declarations as follows:

interface ICustomView {
    use: (dv: IDataView) => {
        render: (container: HTMLElement, ...args: any[]) => HTMLElement; //Create the user custom view.
        dispose?: () => void;  // Unmount hook for the user custom view.
    },
    alias?: string[]; // Alias name for the custom view
}

Once correctly registerd, you can use the custom view like this:

dv.addexample(1);
dv.addcols([dv.table(childs), dv.Example(2)]); //use alias
 */

const custom = {
    example: {
        use: () => {
            let state;
            return {
                render: (element, id) => {
                    console.log('init example custom view with id:', id);
                    state = id;
                    element.innerHTML = 'This is a example custom view ' + id;
                },
                dispose: () => {
                    console.log('dispose example custom view ' + state);
                }
            };
        },
        alias: ['Example', 'ExampleView']
    }
}

export default custom;
`.trimStart();let Le;const Te="query-view.custom.js",be=`/data/public/${Te}`,vt=async()=>{const r=new File([kt],Te,{type:"text/javascript"});return await ze(be,!1,r)},Et=r=>{if(typeof r!="object")return console.warn("Invalid custom query-view module format, should be an object"),!1;for(const[e,t]of Object.entries(r)){if(_t.includes(e))return console.warn(`Invalid custom query-view module format, ${e} is a prohibited method name`),!1;const s=t;if(!s.use||typeof s.use!="function")return console.warn(`Invalid custom query-view module format, ${e} should have a use method`),!1;const{render:n,dispose:i}=s.use(null);if(typeof n!="function")return console.warn(`Invalid custom query-view module format, ${e} render should be a function`),!1;if(i&&typeof i!="function")return console.warn(`Invalid custom query-view module format, ${e} dispose should be a function`),!1}return!0},de=async()=>{const r={ok:!1,exists:!1,valid:!1,custom:null};let e;try{const t=await fetch(be.replace("/data",""),{cache:"no-cache"});if(!t.ok)throw r.exists=!1,new Error(`Failed to fetch custom JS file: ${t.statusText}`);r.exists=!0;const s=await t.text(),n=new Blob([s],{type:"text/javascript"});e=URL.createObjectURL(n);const a=(await import(e)).default;Et(a)?(Le=a,r.valid=!0,r.custom=a):r.valid=!1}catch(t){if(console.warn("Failed to load custom JS file:",t),!r.exists)try{await vt()}catch(s){console.error("Failed to create custom module file:",s)}}finally{e&&URL.revokeObjectURL(e)}return r.ok=r.exists&&r.valid,r},xt=()=>Le;let Y={codeEditor:"code -w {{filepath}}",defaultTableColumns:["type","content","hpath","box"].join(","),echartsRenderer:"svg",onlyImportDtsInUserDoc:!0},L;const St=async r=>{const t=`Device@${window.siyuan.config.system.id}.json`;let s=await r.loadData(t);return s=s||{},{get:n=>s[n],set:async(n,i)=>{s[n]=i,await r.saveData(t,s)}}},$t="setting",Dt=async r=>{const e=await St(r);L=new Ge({plugin:r,name:$t,callback:n=>{e.set("codeEditor",n.codeEditor)},width:"1000px",height:"500px"}),L.addItem({type:"hint",title:exports.i18n.src_setting_indexts.api_interface,description:exports.i18n.src_setting_indexts.apitypedefinition+'<a href="https://github.com/frostime/sy-query-view/blob/main/public/types.d.ts" target="_blank">frostime/sy-query-view/public/types.d.ts</a>',key:"apiDoc",value:""}),L.addItem({type:"checkbox",title:exports.i18n.src_setting_indexts.user_doc_import_type_ref,description:exports.i18n.src_setting_indexts.plugin_import_help_doc,key:"onlyImportDtsInUserDoc",value:Y.onlyImportDtsInUserDoc}),L.addItem({type:"textinput",title:exports.i18n.src_setting_indexts.open_local_editor,description:exports.i18n.src_setting_indexts.local_command_desc,key:"codeEditor",value:Y.codeEditor,direction:"row"}),L.addItem({type:"textinput",title:exports.i18n.src_setting_indexts.table_default_columns,description:exports.i18n.src_setting_indexts.defaultcolumnsofdataviewtable,key:"defaultTableColumns",value:Y.defaultTableColumns,direction:"row"}),L.addItem({type:"button",title:exports.i18n.src_setting_indexts.user_custom_view,description:exports.i18n.src_setting_indexts.user_self_written_view,key:"userCustomView",value:"",button:{label:exports.i18n.src_setting_indexts.reload,callback:async()=>{const n=await de();if(n.ok){let i=Object.keys(n.custom).length;w.showMessage(exports.i18n.src_setting_indexts.import_success.replace("{cnt}",`${i}`),3e3,"info")}else w.showMessage(exports.i18n.src_setting_indexts.import_failed,3e3,"error")}}}),L.addItem({type:"select",title:exports.i18n.src_setting_indexts.echarts_renderer,key:"echartsRenderer",description:exports.i18n.src_setting_indexts.echarts_renderer_option,value:Y.echartsRenderer,options:{canvas:"canvas",svg:"svg"}});const t=await L.load();let s=e.get("codeEditor")??t.codeEditor;L.set("codeEditor",s)},j=new Proxy({},{get:(r,e)=>L.get(e),set:(r,e,t)=>(console.warn("禁止外部修改插件配置变量"),!1)}),Ie=r=>{const e=new w.Dialog({title:r.title,content:'<div class="dialog-content" style="display: flex; height: 100%;"/>',width:r.width,height:r.height,destroyCallback:r.callback});return typeof r.ele=="string"?e.element.querySelector(".dialog-content").innerHTML=r.ele:e.element.querySelector(".dialog-content").appendChild(r.ele),{dialog:e,close:e.destroy.bind(e)}},ke=require("child_process"),Mt=async(r,e)=>{e=window.Lute.UnEscapeHTMLStr(e);const s=Ue(async n=>{const i="{{"+n.replaceAll(`
`,"_esc_newline_")+"}}";Se("markdown",i,r)},1500);if(ke){const n=require("os"),i=require("path"),a=require("fs"),o=e.startsWith("//!js")?"js":"sql",l=i.join(n.tmpdir(),`siyuan-${r}-${Date.now()}.${o}`);a.writeFileSync(l,e);let c,d;const m=()=>{d==null||d.close();try{a.unlinkSync(l)}catch(y){console.error("清理临时文件失败:",y)}},u=j.codeEditor.replace("{{filepath}}",l),f=u.split(" ").map(y=>y.trim()).filter(y=>y!=="");console.debug("About to execute command:",{command:u,commandArr:f,codeEditor:j.codeEditor});let g=f[0];try{c=ke.spawn(g,f.slice(1),{shell:!0})}catch(y){console.error("启动代码编辑器失败:",y),w.showMessage(exports.i18n.src_core_editorts.unusableexteditorcmd.replace("{0}",u),5e3,"error"),m();return}c.on("error",y=>{console.error("代码编辑器错误:",y),w.showMessage(exports.i18n.src_core_editorts.unusableexteditorcmd.replace("{0}",u)),m()}),c.on("exit",()=>{w.showMessage(exports.i18n.src_core_editorts.ext_code_editor_closed.replace("{0}",f[0])),console.log("代码编辑器已关闭");try{const y=a.readFileSync(l,"utf-8");s(y)}catch(y){console.error("读取文件失败:",y)}m()}),d=a.watch(l,(y,x)=>{if(y==="change")try{const k=a.readFileSync(l,"utf-8");s(k)}catch(k){console.error("读取文件失败:",k)}})}else w.showMessage(exports.i18n.src_dataquery_editorts.onlydesktop,3e3,"error")};async function Ne({detail:r}){if(r.blockElements.length>1)return;let e=r.blockElements[0];if(e.getAttribute("data-type")!=="NodeBlockQueryEmbed")return;let s=e.getAttribute("data-node-id"),n=r.menu;n.addItem({icon:"iconGit",label:"Edit Code",click:()=>{Mt(s,e.dataset.content)}}),n.addItem({icon:"iconMarkdown",label:exports.i18n.src_core_editorts.show_as_template_format,click:()=>{let i=e.dataset.content;i=window.Lute.UnEscapeHTMLStr(i),i=i.replace(/\n/g,"_esc_newline_");const a=document.createElement("textarea");a.value=`{{${i}}}`,a.style.flex="1",a.style.fontSize="16px",a.style.margin="15px 10px",a.style.borderRadius="5px",a.style.resize="none",a.setAttribute("readonly","true"),Ie({title:exports.i18n.src_core_editorts.show_embedded_block_code_in_siyuan_template_format,ele:a,width:"700px",height:"300px"})}})}const Q=r=>r!=null&&r.unwrapped?r:new Proxy(r,{get(t,s){if(s in t)return t[s];switch(s){case"unwrap":return()=>t;case"unwrapped":return t;case"asurl":case"tourl":return`siyuan://blocks/${r.id}`;case"aslink":case"tolink":return`[${r.fcontent||r.content}](siyuan://blocks/${r.id})`;case"asref":case"toref":return`((${r.id} '${r.fcontent||r.content}'))`;case"attr":return(i,a)=>{let o;return a&&(o=a(r,i)),o??D(r,i)};case"asial":let n=D(r,"ial");return JSON.parse(n);case"updatedDate":return D(r,"updated",{onlyDate:!0});case"createdDate":return D(r,"created",{onlyDate:!0});case"updatedTime":return D(r,"updated",{onlyTime:!0});case"createdTime":return D(r,"created",{onlyTime:!0});case"updatedDatetime":return D(r,"updated");case"createdDatetime":return D(r,"created")}if(s.startsWith("custom-")){let n=r.ial,i=new RegExp(`${s}="(.*?)"`),a=n.match(i);return a?a[1]:""}return null}}),v=(r,e=!0)=>{if(r!=null&&r.unwrapped)return r;r=e?r.map(s=>Q(s)):r;let t=new Proxy(r,{get(s,n){if(n in s&&!["filter","slice"].includes(n))return Reflect.get(s,n);switch(n){case"unwrap":return()=>s;case"unwrapped":return s;case"asMap":case"asmap":return(i="id")=>s.reduce((a,o)=>(a[o[i]]=o,a),{});case"pick":return(...i)=>{if(i.length===1){if(Array.isArray(i[0]))return i=i[0],t.pick(...i);let a=s.map(o=>o[i[0]]);return v(a,!1)}else{let a=s.map(o=>{let l={};return i.forEach(c=>{l[c]=o[c]??null}),l});return v(a)}};case"omit":return(...i)=>{if(i.length===1&&Array.isArray(i[0]))return i=i[0],t.omit(...i);const a=new Set(i),o=s.map(l=>Object.fromEntries(Object.entries(l).filter(([c])=>!a.has(c))));return v(o)};case"toSorted":return i=>v(s.toSorted(i));case"sorton":return(i,a="desc")=>{let o=s.toSorted((l,c)=>l[i]>c[i]?a==="asc"?1:-1:l[i]<c[i]?a==="asc"?-1:1:0);return v(o)};case"groupby":return(i,a)=>{const o={},l=c=>typeof i=="function"?i(c):c[i];return s.forEach(c=>{const d=l(c);d in o||(o[d]=v([])),o[d].push(c)}),a&&Object.entries(o).forEach(([c,d])=>{a(c,d)}),o};case"filter":return i=>{const a=Array.prototype.filter.call(s,i);return v(a)};case"slice":return(i,a)=>{const o=Array.prototype.slice.call(s,i,a);return v(o)};case"unique":return i=>{var l;if(s.length===0)return t;const a={},o=(l=s[0])!=null&&l.id?"id":c=>c;return i=i??o,typeof i=="function"?s.forEach(c=>a[i(c)]=c):s.forEach(c=>a[c[i]]=c),v(Object.values(a))};case"addrow":case"addrows":case"concat":return(...i)=>v(s.concat(...i));case"addcol":case"addcols":case"stack":return i=>{const a=s.length,o=s.map(l=>({...l}));if(typeof i=="function"){for(let l=0;l<a;l++){const c=i(s[l],l);Object.entries(c).forEach(([d,m])=>{const h=Array.isArray(m)?m[l]:m;o[l][d]=h})}return v(o)}if(Array.isArray(i)){if(i.length!==a)throw new Error("Input array length must match target array length");for(let l=0;l<a;l++)Object.assign(o[l],i[l]);return v(o)}return Object.entries(i).forEach(([l,c])=>{if(Array.isArray(c)){if(c.length!==a)throw new Error(`Array length for key "${l}" must match target array length`);for(let d=0;d<a;d++)o[d][l]=c[d]}else for(let d=0;d<a;d++)o[d][l]=c}),v(o)}}return null}});return t};class Lt{constructor(e){p(this,"maxConcurrent");p(this,"currentRunning",0);p(this,"queue",[]);p(this,"promises",[]);this.maxConcurrent=e}add(e){const t=new Promise((s,n)=>{const i=async()=>{try{this.currentRunning++;const a=await e();s(a)}catch(a){n(a)}finally{this.currentRunning--,this.next()}};this.currentRunning<this.maxConcurrent?i():this.queue.push(i)});this.promises.push(t)}async awaitAll(){return Promise.all(this.promises)}next(){this.queue.length>0&&this.currentRunning<this.maxConcurrent&&this.queue.shift()()}}async function Tt(r,e,t="data"){let s=await w.fetchSyncPost(r,e),n=s.code===0?s.data:null;return t==="data"?n:s}async function It(r){return Tt("/api/query/sql",{stmt:r})}const Nt={},Ct={};window.siyuan.config.lang.startsWith("zh");const At={d:"NodeDocument",p:"NodeParagraph",query_embed:"NodeBlockQueryEmbed",l:"NodeList",i:"NodeListItem",h:"NodeHeading",iframe:"NodeIFrame",tb:"NodeThematicBreak",b:"NodeBlockquote",s:"NodeSuperBlock",c:"NodeCodeBlock",widget:"NodeWidget",t:"NodeTable",html:"NodeHTMLBlock",m:"NodeMathBlock",av:"NodeAttributeView",audio:"NodeAudio"};Object.fromEntries(Object.entries(At).map(([r,e])=>[e,r]));const Ce=()=>{const r=window.siyuan.config.system.kernelVersion,[e,t,s]=r.split(".").map(Number),n=(i,a)=>i>a?1:i<a?-1:0;return{major:e,minor:t,patch:s,version:r,compare:i=>{const[a,o,l]=i.split(".").map(Number);return n(e,a)||n(t,o)||n(s,l)}}},Bt=r=>{const{title:e,content:t,confirm:s,cancel:n,width:i,height:a,maxWidth:o,maxHeight:l}=r,c=new w.Dialog({title:e,content:`<div class="b3-dialog__content">
    <div class="ft__breakword" style="height: 100%;">
    </div>
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text" id="confirmDialogConfirmBtn">${window.siyuan.languages.confirm}</button>
</div>`,width:i,height:a,destroyCallback:r.destroyCallback}),d=c.element.querySelector(".b3-dialog__content>div.ft__breakword");typeof t=="string"?d.innerHTML=t:d.appendChild(t);const m=c.element.querySelectorAll(".b3-button");m[0].addEventListener("click",()=>{n&&n(d),c.destroy()}),m[1].addEventListener("click",()=>{s&&s(d),c.destroy()});const h=c.element.querySelector(".b3-dialog__container");return h&&Object.assign(h.style,{maxWidth:o,maxHeight:l}),{dialog:c,close:c.destroy.bind(c),container:h}};async function Ot(r){let e=`select * from blocks where id ='${r}'`,t=await It(e);return t==null?void 0:t[0]}const ve=new Set;function H(r,e,t,s={},n){let i=!1;for(const o in s)s[o]===void 0&&delete s[o];let a={...e};if(typeof t=="object"&&!Array.isArray(t)?a={...a,...t}:t!==void 0&&n&&(a[n]=t,i=!0),s&&Object.keys(s).length>0&&(a={...a,...s},i=!0),i){const o=exports.i18n.src_core_queryts.query_obsolete_params;console.warn(o.replace("{0}",r)),ve.has(r)||(w.showMessage(o.replace("{0}",r),7e3,"error"),ve.add(r))}return a}async function jt(r,e="leaf",t=!1){var l;let s=new Set,n=new Map;r.forEach(c=>{s.add(c.parent_id),n.set(c.id,c)});let i=new Set;const a=c=>{i.has(c.id)||i.add(c.id)};if(e==="root")for(let c of r){for(;n.has(c.parent_id);)c=n.get(c.parent_id);a(c)}else if(e==="leaf")for(let c of r)s.has(c.id)||a(c);if(t){const c=async u=>(await E("/api/block/getBlockBreadcrumb",{id:u,excludeTypes:[]})).map(y=>y.id).join("/"),d=new Lt(16),m=new Map;for(const u of i)d.add(async()=>{const f=await c(u);m.set(u,f)});await d.awaitAll();const h=new Map;for(const[u,f]of m.entries())for(const[g,y]of m.entries())u!==g&&y.startsWith(f)&&(h.has(u)||h.set(u,[]),(l=h.get(u))==null||l.push(g));if(e==="root"){for(const[u,f]of h.entries())if(f.length>0)for(const g of f)i.delete(g)}else if(e==="leaf")for(const[u,f]of h.entries())f.length>0&&i.delete(u)}return Array.from(i).map(c=>n.get(c))}async function F(...r){let e=r.map(i=>`"${i}"`),t=r.length,s=`select * from blocks where id in (${e.join(",")}) limit ${t+1}`;return await J(s)}const qt=r=>r.reduce((e,t)=>(e[t.id]=t,e),{});class $ extends Date{beginOfDay(){const e=new $(this.getTime());return e.setHours(0,0,0,0),e}toString(e=!0){return O("yyyyMMdd"+(e?"HHmmss":""),this)}[Symbol.toPrimitive](e){switch(e){case"string":return this.toString();default:return super[Symbol.toPrimitive](e)}}static fromString(e){return new $(e.replace(/(\d{4})(\d{2})(\d{2})(\d{2})(\d{2})(\d{2})/,"$1-$2-$3 $4:$5:$6"))}format(e="yyyy-MM-dd HH:mm:ss"){return O(e,this)}add(e){const t=()=>{if(typeof e=="string"){const a=e.match(/^(-?\d+)(d|w|m|y)$/);if(a)return{unit:a[2],delta:parseInt(a[1])}}return{unit:"d",delta:e??0}},{unit:s,delta:n}=t(),i=new $(this.getTime());switch(s){case"d":i.setDate(i.getDate()+n);break;case"w":i.setDate(i.getDate()+n*7);break;case"m":i.setMonth(i.getMonth()+n);break;case"y":i.setFullYear(i.getFullYear()+n);break}return i}}const b={DataView:(r,e,t)=>($e(),new ne(r,e,t)),Utils:{Date:(...r)=>new $(...r),now:(r,e=!0)=>{let t=new $;return t=t.add(r),t.toString(e)},today:(r=!0)=>new $().beginOfDay().toString(r),thisWeek:(r=!0)=>{let e=new $().beginOfDay();return e.setDate(e.getDate()-e.getDay()),e.toString(r)},lastWeek:(r=!0)=>{let e=new $().beginOfDay();return e.setDate(e.getDate()-7-e.getDay()),e.toString(r)},thisMonth:(r=!0)=>{let e=new $;return e.setDate(1),e=e.beginOfDay(),e.toString(r)},lastMonth:(r=!0)=>{let e=new $().beginOfDay();return e.setMonth(e.getMonth()-1),e.setDate(1),O("yyyyMMdd"+(r?"HHmmss":""),e)},thisYear:(r=!0)=>{let e=new $().beginOfDay();return e.setMonth(0),e.setDate(1),O("yyyyMMdd"+(r?"HHmmss":""),e)},asDate:r=>$.fromString(r),asTimestr:r=>new $(r).toString(),asLink:r=>`[${r.fcontent||r.content}](siyuan://blocks/${r.id})`,asRef:r=>`((${r.id} '${r.fcontent||r.content}'))`,asMap:(r,e="id")=>r.reduce((t,s)=>(t[s[e]]=s,t),{}),notebook:r=>{const e=typeof r=="string"?r:r.box;return ee(e)},boxName:r=>ee(r).name,typeName:r=>P[r]??r,docIcon:r=>{if(r.type!=="d")return null;let e=Q(r).asial.icon;return e?b.Utils.emoji(e):"📄"},emoji:r=>{let e=parseInt(r,16);return Number.isNaN(e)?null:String.fromCodePoint(e)},renderAttr:D,openBlock:W},wrapBlocks:(r,e=!0)=>Array.isArray(r)?v(r,e):Q(r),request:E,getBlocksByIds:async(...r)=>{let e=r.flat(),t=await F(...e);return b.wrapBlocks(t)},id2block:async r=>{let e=await F(...Array.isArray(r)?r:[r]);return Array.isArray(r)?b.wrapBlocks(e):Q(e[0])},root_id:r=>r.block.rootID,thisDoc:async r=>{let e=r.block.rootID,t=await J(`select * from blocks where id = '${e}'`);return Q(t[0])},sql:async(r,e=!0)=>{r=r.trim();let t=await J(r);return t==null?[]:e?v(t):t},backlink:async(r,e)=>b.sql(`
        select * from blocks where id in (
            select block_id from refs where def_block_id = '${r}'
        ) order by updated desc ${e?`limit ${e}`:""};
        `),attr:async(r,e,t,s)=>{const n=H("attr",{valMatch:"=",limit:void 0},t,{limit:s},"valMatch"),{valMatch:i,limit:a}=n;return b.sql(`
        SELECT B.*
        FROM blocks AS B
        WHERE B.id IN (
            SELECT A.block_id
            FROM attributes AS A
            WHERE A.name like '${r}'
            ${e?`AND A.value ${i} '${e}'`:""}
            ${a?`limit ${a}`:""}
        );
        `)},tag:async(r,e,t)=>{const s=H("tag",{join:"or",limit:void 0,match:"="},e,{limit:t},"join"),{join:n,limit:i,match:a}=s,o=(c,d)=>(c=c.replace(/^[#%]+/,"").replace(/[#%]+$/,""),d?`%#%${c}%#%`:`%#${c}#%`);r=Array.isArray(r)?r:[r];const l=r.map(c=>`tag like '${o(c,a==="like")}'`).join(` ${n} `);return b.sql(`select * from blocks where
            (type='d' or type='p' or type='h') and
            (${l})
            ${i?`limit ${i}`:""}
        `)},task:async(r,e)=>{const t=H("task",{limit:void 0,after:void 0},r,{limit:e},"after"),{limit:s,after:n}=t,i=Ce().compare("3.1.29")>=0?"-":"*";return b.sql(`
            select * from blocks
            where type = 'i' and subtype = 't'
            and markdown like '${i} [ ] %'
            ${n?` and updated >= ${n}`:""}
            order by updated desc
            ${s?`limit ${s}`:""};
        `)},dailynote:async(r,e)=>{const t=H("dailynote",{notebook:void 0,limit:64},r,{limit:e},"notebook");let{notebook:s,limit:n}=t;r.box&&!s&&(s=r.box);const i=`
        SELECT B.*
        FROM blocks AS B
        WHERE B.id IN (
            SELECT A.block_id
            FROM attributes AS A
            WHERE A.name like 'custom-dailynote-%'
        ) AND B.type = 'd' ${s?`AND B.box = '${s}'`:""}
        limit ${n};
        `;return b.sql(i)},childDoc:async r=>{let e=null;typeof r=="string"?e=(await F(r))[0]:e=r;let t=await Re(e.box,e.path),n=((t==null?void 0:t.files)||[]).map(o=>o.id),i=await F(...n),a=qt(i);return i=n.map(o=>a[o]),v(i)},nearby:async(r,e)=>{e=e??{};const{direction:t="both",number:s=3}=e,n=await Ot(r),i=n.parent_id||n.root_id,a=await E("/api/block/getChildBlocks",{id:i});if(!a)return{};const o=a.findIndex(c=>c.id===r);if(o===-1)return{};const l={};return(t==="previous"||t==="both")&&(l.previous=a.slice(Math.max(0,o-s),o)),(t==="next"||t==="both")&&(l.next=a.slice(o+1,o+1+s)),l},keyword:async(r,e,t)=>{const s=H("keyword",{join:"or",limit:999},e,{limit:t},"join"),{join:n,limit:i}=s;r=Array.isArray(r)?r:[r];const a=`select * from blocks where ${r.map(l=>`content like '%${l}%'`).join(` ${n} `)} limit ${i}`;return await b.sql(a)},keywordDoc:async(r,e,t)=>{const s=H("keywordDoc",{join:"or",limit:999},e,{limit:t},"join"),{join:n,limit:i}=s;r=Array.isArray(r)?r:[r];const a=`select * from blocks where ${r.map(m=>`content like '%${m}%'`).join(` ${n} `)} limit ${i}`;let o=await b.sql(a),l={};o.groupby(m=>m.root_id,(m,h)=>{let u=Object.fromEntries(r.map(g=>[g,null]));h.forEach(g=>{r.forEach(y=>{g.content.includes(y)&&(u[y]=g)})});let f=!0;for(let g of r)if(!u[g]){f=!1;break}f&&(l[m]=u)});let c=Object.keys(l),d=await b.getBlocksByIds(...c);for(let m=0;m<d.length;m++){const h=d[m];h.keywords=l[h.root_id]}return d},random:async(r=64,e)=>{const t=`select * from blocks
        ${e?`where type = '${e}'`:""}
        order by random()
        limit ${r};`;return b.sql(t)},markdown:async r=>{let e=null;typeof r=="string"?e=(await F(r))[0]:e=r;const t=e.id;if(e.type==="d"||e.type==="h"){const n=(await E("/api/block/getChildBlocks",{id:t})).map(a=>a.markdown).join(`

`);return e.type==="d"?n:`${e.markdown}

${n}`}else return e.markdown},docStat:async r=>await E("/api/block/getTreeStat",{id:r}),fb2p:async(r,e)=>{r=[...r];let t=typeof r[0]=="string"?"id":"block",s=t==="id"?r:r.map(l=>l.id),n=r;e={heading:!0,doc:!0,...e??{}},t=="id"&&(n=n.map(l=>({id:l})));let i=await E("/api/block/getBlockTreeInfos",{ids:s}),a=[],o={blocks:{},addTask:l=>{o.blocks[l.id]=l},run:async()=>{let l=await F(...Object.keys(o.blocks));for(let c of l)o.blocks[c.id]&&Object.assign(o.blocks[c.id],c)}};for(let l of n){a.push(l);let c=i[l.id];if(c.type!=="NodeParagraph")continue;const d=l.content.trim();if(/#(文档引用|DOCREF)#/.test(d)){console.debug("发现文档引用",l.id);let h=a[a.length-1];h.id=l.root_id,h.type="d",o.addTask(h);continue}if(c.previousID===""&&["NodeBlockquote","NodeListItem","NodeSuperBlock"].includes(c.parentType)){let h=a[a.length-1];h.id=c.parentID,h.type={NodeBlockquote:"b",NodeListItem:"i",NodeSuperBlock:"sb"}[c.parentType]}else if(e.heading&&c.previousType==="NodeHeading"){let h=a[a.length-1];h.id=c.previousID,h.type="h",o.addTask(h)}else if(e.doc&&c.previousID===""&&c.parentType==="NodeDocument"){let h=a[a.length-1];h.id=c.parentID,h.type="d",o.addTask(h)}}return await o.run(),v(a)},pruneBlocks:async(r,e="leaf",t=!1)=>{let s=await jt(r,e,t);return v(s,!0)},gpt:async(r,e)=>{var l,c,d;let{apiBaseURL:t,apiModel:s,apiKey:n}=window.siyuan.config.ai.openAI;s=(e==null?void 0:e.model)??s,n=(e==null?void 0:e.apiKey)??n;let i;e!=null&&e.url?i=e.url:i=`${t.endsWith("/")?t:t+"/"}chat/completions`;let a=[];typeof r=="string"?a=[{role:"user",content:r}]:a=[...r],e!=null&&e.history&&(a=[...e.history,...a]);const o={model:s,messages:a,stream:(e==null?void 0:e.stream)??!1};try{const m=await fetch(i,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${n}`,Accept:"text/event-stream"},body:JSON.stringify(o)});if(!m.ok)throw new Error(`HTTP error! status: ${m.status}`);if(e!=null&&e.stream){const u=(l=m.body)==null?void 0:l.getReader();if(!u)throw new Error("Failed to get response reader");e.streamInterval=e.streamInterval??1;const f=new TextDecoder;let g="";try{let y=0;for(;;){const{done:x,value:k}=await u.read();if(x)break;const R=f.decode(k).split(`
`).filter(C=>C.trim()!=="");for(const C of R)if(!C.includes("[DONE]")&&C.startsWith("data: "))try{const M=JSON.parse(C.slice(6));if(!((c=M.choices[0].delta)!=null&&c.content))continue;const U=M.choices[0].delta.content;g+=U}catch(M){console.warn("Failed to parse stream data:",M)}y%e.streamInterval===0&&((d=e.streamMsg)==null||d.call(e,g)),y++}}catch(y){throw console.error("Stream reading error:",y),y}finally{u.releaseLock()}return g}const h=await m.json();return e!=null&&e.returnRaw?h:h.choices[0].message.content}catch(m){return`[Error] Failed to request openai api, ${m}`}}},I=(r,e,t)=>{e in r&&(t=t??[],t.forEach(s=>{s in r||(r[s]=r[e])}))};I(b,"DataView",["Dataview"]);I(b,"Utils",["utils"]);I(b,"getBlocksByIds",["getBlockById","getBlocksById"]);I(b,"root_id",["docId"]);I(b,"backlink",["backlinks"]);I(b,"wrapBlocks",["wrapit"]);I(b,"fb2p",["redirect"]);I(b,"pruneBlocks",["prune","mergeBlocks","merge"]);const Rt=Object.keys(b.Utils);Rt.forEach(r=>{I(b.Utils,r,[r.toLocaleLowerCase()])});Object.keys(b).forEach(r=>{I(b,r,[r.toLocaleLowerCase()])});var xe;const ue=(xe=window==null?void 0:window.require)==null?void 0:xe.call(window,"child_process"),Ee=r=>{var a;if(!ue)return;const e=window.siyuan.config.system.workspaceDir,t=window==null?void 0:window.require("path"),s=t.join(e,be),n=t.dirname(s),i=(a=window==null?void 0:window.require)==null?void 0:a.call(window,"electron");if(!i){let o=r==="file"?exports.i18n.src_userhelp_indexts.unable_open_custom_view:exports.i18n.src_userhelp_indexts.unable_open_custom_view_dir;w.showMessage(o,3e3,"error");return}if(r==="file"){const o=j.codeEditor.replace("{{filepath}}",s);ue.exec(o,(l,c,d)=>{l&&console.warn("Error executing command:",l)})}else i==null||i.shell.openPath(n)},Ht=r=>{globalThis.Query=b,r.eventBus.on("click-blockicon",Ne),r.eventBus.on("destroy-protyle",Me),de().then(t=>{if(t.exists&&!t.valid){w.showMessage(r.i18n.src_core_indexts.custom_queryview_error,5e3,"error");return}t.ok&&console.debug(`Load custom query-view: ${Object.keys(t.custom)}`)});const e=[{label:exports.i18n.src_core_indexts.reload_custom_comp,icon:"iconAccount",click:async()=>{const t=await de();if(t.ok){let s=Object.keys(t.custom).length;w.showMessage(exports.i18n.src_setting_indexts.import_success.replace("{cnt}",`${s}`),3e3,"info")}else w.showMessage(exports.i18n.src_setting_indexts.import_failed,3e3,"error")}}];ue&&(e.push({label:exports.i18n.src_userhelp_indexts.edit_custom_view,icon:"iconCode",click:()=>{try{Ee("file")}catch(t){console.error(t),w.showMessage(exports.i18n.src_userhelp_indexts.unable_open_custom_view,3e3,"error")}}}),e.push({label:exports.i18n.src_userhelp_indexts.open_custom_view_dir,icon:"iconFolder",click:()=>{try{Ee("dir")}catch(t){console.error(t),w.showMessage(exports.i18n.src_userhelp_indexts.unable_open_custom_view_dir,3e3,"error")}}})),r.registerMenuItem({label:"CustomView",icon:"iconCode",submenu:e})},Ft=r=>{we(),delete globalThis.Query,r.eventBus.off("click-blockicon",Ne),r.eventBus.off("destroy-protyle",Me)},Z="custom-query-view-user-readme",Pt=(r,e)=>{const t=a=>a.replace(/\D/g,""),s=a=>(a=t(a),a.length>0?Number(a):0),n=r.split(".").map(s),i=e.split(".").map(s);for(let a=0;a<n.length;a++){if(n[a]>i[a])return 1;if(n[a]<i[a])return-1}return 0},Vt="\n> {{//!js_esc_newline_const query = async () => {_esc_newline_    let dv = Query.DataView(protyle, item, top);_esc_newline_    let ans = await Query.request('/api/outline/getDocOutline', {_esc_newline_        id: Query.root_id(protyle)_esc_newline_    });_esc_newline_    ans = Query.wrapit(ans);_esc_newline_    const iterate = (data) => {_esc_newline_        for (let item of data) {_esc_newline_            if (item.count > 0) {_esc_newline_                let subtocs = iterate(item.blocks ?? item.children);_esc_newline_                item.children = Query.wrapBlocks(subtocs);_esc_newline_            }_esc_newline_        }_esc_newline_        return data;_esc_newline_    }_esc_newline_    let tocs = iterate(ans);_esc_newline_    dv.addlist(tocs, {_esc_newline_	    renderer: b => `[${b.name || b.content}](${b.asurl})`,_esc_newline_            columns: 2_esc_newline_    });_esc_newline_    dv.render();_esc_newline_}_esc_newline__esc_newline_return query();}}\n".trim(),Ae=async r=>{const t=window.siyuan.config.lang.startsWith("zh")?"README_zh_CN.md":"README.md";let n=await(await fetch(`/plugins/sy-query-view/${t}`)).text();if(j.onlyImportDtsInUserDoc){const o="`<!-- REFERENCE-START -->`",l="`<!-- REFERENCE-END -->`",c=n.indexOf(o),d=n.indexOf(l),m=exports.i18n.src_userhelp_sydocts.plugin_setting_doc;c!==-1&&d!==-1&&(n=n.substring(c+o.length,d).trim()),n=m+`

`+n}return n=exports.i18n.user_help.ahead_hint.trim().replace("{{version}}",r.version)+`
`+Vt+`

`+n,n},zt=async(r,e)=>{const t=window.siyuan.notebooks.filter(o=>o.closed===!1);if(t.length===0)return w.showMessage(exports.i18n.src_userhelp_indexts.create_notebook),null;const s=t[0];let n=await Ae(r),i=await qe(s.id,`/${e}`,n);const a={[Z]:r.version,"custom-sy-readonly":"true"};return await fe(i,a),i},Wt=async r=>{const e=await J(`
        SELECT B.*, A.value as version
        FROM blocks AS B
        JOIN attributes AS A ON A.block_id = B.id
        WHERE A.name = '${Z}'
        ORDER BY B.UPDATED DESC;
    `);let t=null;if(!e||e.length===0){const a=`${r.displayName}@${r.version} `+exports.i18n.src_userhelp_indexts.help_doc;t=await zt(r,a),w.showMessage(exports.i18n.src_userhelp_sydocts.create_user_doc+" "+a)}else if(e.length===1)t=e[0].id;else{e.sort((o,l)=>Pt(l.version,o.version)),t=e[0].id;const a=e.slice(1);for(let o of a)await Fe(o.box,o.path)}if(!t)return;const s=await J(`
        SELECT A.value
        FROM attributes AS A
        WHERE A.name = '${Z}'
        AND A.block_id = '${t}'
    `);if(s.length===0)return;const n=s[0].value,i=async()=>{w.showMessage(exports.i18n.src_userhelp_sydocts.plugin_update_doc,5e3);let a=await Ae(r);const o=`${r.displayName}@${r.version} `+exports.i18n.src_userhelp_indexts.help_doc,l=e[0];await He(l.box,l.path,o),await Se("markdown",a,t),await fe(t,{[Z]:r.version,"custom-sy-readonly":"true"})};n.trim()!==r.version.trim()&&await i(),setTimeout(()=>{W(t)},0)},Ut="_link_gumjd_1",he={link:Ut,"to-top":"_to-top_gumjd_7"};let me=`
<div class="${he["to-top"]}">
    <svg>
        <use xlink:href="#iconUp"></use>
    </svg>
</div>
`;const z={"exp-month-todo.js":()=>exports.i18n.src_userhelp_examplests.query_this_month_todo,"exp-child-docs.js":()=>exports.i18n.src_userhelp_examplests.list_doc_subsections,"exp-avs-under-root-doc.js":()=>exports.i18n.src_userhelp_examplests.query_attr_views,"exp-doc-backlinks-table.js":()=>exports.i18n.src_userhelp_examplests.backlinks_table,"exp-doc-backlinks-grouped.js":()=>exports.i18n.src_userhelp_examplests.doc_backlinks_grouping,"exp-outline.js":()=>exports.i18n.src_userhelp_examplests.doc_outline_tree,"exp-list-tags.js":()=>exports.i18n.src_userhelp_examplests.show_tags_card_view,"exp-latest-update-doc.js":()=>exports.i18n.src_userhelp_examplests.recent_docs,"exp-today-updated.js":()=>exports.i18n.src_userhelp_examplests.updated_docs_today,"exp-created-docs.js":()=>exports.i18n.src_userhelp_examplests.docs_per_month,"exp-sql-executor.js":()=>exports.i18n.src_userhelp_examplests.sql_exec_result,"exp-gpt-chat.js":()=>exports.i18n.src_userhelp_examplests.simple_chatgpt,"exp-doc-backlinks-graph.js":()=>exports.i18n.src_userhelp_examplests.echarts_graph_ref,"exp-show-asset-images.js":()=>exports.i18n.src_userhelp_examplests.view_assets_images,"exp-daily-sentence.js":()=>exports.i18n.src_userhelp_examplests.daily_quote,"exp-gpt-translate.js":()=>exports.i18n.src_userhelp_examplests.random_text_translate,"exp-doc-tree.js":()=>exports.i18n.src_userhelp_examplests.query_doc_tree,"exp-month-todo-kanban.js":()=>exports.i18n.src_userhelp_examplests.unfinished_task_monthly,"exp-month-todo-timeline.js":()=>exports.i18n.src_userhelp_examplests.query_unfinished_tasks},Kt=(r,e)=>{var n;let t=((n=z[r])==null?void 0:n.call(z))??"",s=`
<h4 id="${r.replace(/\s+/g,"-").toLowerCase()}">${r}</h4>

${t?`<blockquote style="margin: 5px 0;">${t}</blockquote>`:""}

<textarea
    class="form-control b3-text-field fn__block"
    rows="15" readonly
    style="font-size: 1.25rem; line-height: 1.5rem; resize: vertical;"
>
${e}
</textarea>

<hr/>

`;me+=s},Qt=async r=>await(await Ve(r)).text(),Jt=async r=>{const e=`/data/plugins/${r.name}/example`;let s=(await We(e)).map(l=>l.name);const n=Object.keys(z);s.sort((l,c)=>{if(z[l]===void 0)return 1;if(z[c]===void 0)return-1;const d=n.indexOf(l),m=n.indexOf(c);return d-m});const a=`
    <h3 class="TOC">TOC</h3>
    <ol style="columns: 3;">${s.map(l=>`<li>
            <span class="${he.link}" data-target="${l.replace(/\s+/g,"-").toLowerCase()}">
                ${l}
            </span>
        </li>`).join("")}</ol>

    <h3> Examples </h3>
    `;me+=a;for(const l of s){let c=l;const d=`${e}/${c}`,m=await Qt(d);Kt(c,m)}const o=l=>{var d;const c=l.target;if(c.tagName==="SPAN"&&c.hasAttribute("data-target")){const m=c.getAttribute("data-target"),h=document.getElementById(m);h&&h.scrollIntoView({behavior:"smooth"})}else if(c.closest(`.${he["to-top"]}`)){const m=c.closest(".item__readme");(d=m==null?void 0:m.querySelector("h3.TOC"))==null||d.scrollIntoView({behavior:"smooth"})}};return r.addTab({type:"js-example",init(){const l=document.createElement("div");l.classList.add("item__readme"),l.classList.add("b3-typography"),l.classList.add("b3-typography--default"),l.innerHTML=me,l.style.padding="10px 15%",this.element.appendChild(l),this.element.addEventListener("click",o)},destroy(){this.element.removeEventListener("click",o)}}),{open(){w.openTab({app:r.app,custom:{id:`${r.name}js-example`,title:"Query&View Examples",icon:"iconCode"}})}}},pe=require("child_process"),Gt=()=>`
//!js
const query = async () => {
    //${exports.i18n.src_userhelp_indexts.useview}
    //let dv = Query.DataView(protyle, item, top);

    const SQL = \`
        select * from blocks
        order by random()
        limit 5;
    \`;
    let blocks = await Query.sql(SQL);

    return blocks.pick('id');
    //${exports.i18n.src_userhelp_indexts.useview2}
    //dv.addlist(blocks);
    //dv.render();
}

return query();
`.trim(),Yt=r=>(r=r.trim(),"{{"+r.replaceAll(`
`,"_esc_newline_")+`}}
{: breadcrumb="true" }`),Xt=()=>{if(!pe)return;const r="/plugins/sy-query-view/types.d.ts",e=window.siyuan.config.system.dataDir,s=(window==null?void 0:window.require("path")).join(e,r),i=j.codeEditor.replace("{{filepath}}",s);pe.exec(i,(a,o,l)=>{a&&console.warn("Error executing command:",a)})},Zt=async r=>{const t=await fetch("/plugins/sy-query-view/plugin.json").then(a=>a.json()),s=t.name,n=t.version;r.protyleSlash.push({filter:["qv-basic","queryview"],html:exports.i18n.src_userhelp_indexts.queryview,id:s,callback:a=>{a.insert(window.Lute.Caret,!1,!1);const o=document.getSelection();if(o.rangeCount===0)return;const d=o.getRangeAt(0).startContainer.parentElement.closest("div[data-node-id]");if(!d)return;const m=d.getAttribute("data-node-id");setTimeout(async()=>{await Pe("markdown",Yt(Gt()),null,m,null)},500)}}),pe&&r.registerMenuItem({label:exports.i18n.src_userhelp_indexts.open_locally+" d.ts",icon:"iconEdit",click:()=>{try{Xt()}catch(a){console.error(a),w.showMessage(exports.i18n.src_userhelp_indexts.unable_open_d_ts,3e3,"error")}}}),r.registerMenuItem({label:exports.i18n.src_userhelp_indexts.download+" d.ts",icon:"iconDownload",click:()=>{const a="/plugins/sy-query-view/types.d.ts",o=document.createElement("a");o.href=a,o.download=`${s}@${n}.types.d.ts`,o.click()}}),r.version=n,r.registerMenuItem({label:exports.i18n.src_userhelp_indexts.help_doc,icon:"iconHelp",click:()=>{Wt(r)}});const{open:i}=await Jt(r);r.registerMenuItem({label:"Examples",icon:"iconCode",click:i})};exports.i18n=void 0;exports.app=void 0;const X=()=>{console.debug("Close Window"),we()};class es extends w.Plugin{constructor(){super(...arguments);p(this,"disposeCb",[]);p(this,"topBarMenuItems",[])}init(){this.protyleSlash=[],this.addIcons(ts);const t=()=>{let n=new w.Menu("query-view");this.topBarMenuItems.forEach(a=>{n.addItem(a)}),n.addSeparator(),n.addItem({label:"Manual Dispose",icon:"iconTrashcan",click:()=>{Bt({title:exports.i18n.src_indexts.manual_release,content:exports.i18n.src_indexts.manual_release_desc,confirm:()=>{we(),w.showMessage("All views have been disposed",3e3,"info")}})}}),n.addItem({icon:"iconSettings",label:"Setting",click:()=>{this.openSetting()}});const i=s.getBoundingClientRect();n.open({x:i.left,y:i.bottom,isLeft:!1})},s=this.addTopBar({icon:"iconQueryView",title:"Query&View",position:"left",callback:t})}registerMenuItem(t){this.topBarMenuItems.push(t)}async onload(){exports.i18n=this.i18n;const t=Ce();if(t.version==="3.1.25"||t.version==="3.1.26"){const s="⚠️"+exports.i18n.src_indexts.incompatible_version.replace("{0}",t.version);if(t.version==="3.1.25"){Ie({title:exports.i18n.src_indexts.plugin_not_working,ele:`<div class="b3-label">${s}</div>`});return}else w.showMessage(s,-1,"error")}exports.app=this.app,this.init(),Dt(this),Ht(this),Zt(this)}async onunload(){Ft(this),this.disposeCb.forEach(t=>t())}onLayoutReady(){window.addEventListener("beforeunload",X),this.disposeCb.push(()=>{window.removeEventListener("beforeunload",X)});const t=document.querySelector("div#windowControls > div#closeWindow");t&&(t.addEventListener("click",X,!0),this.disposeCb.push(()=>{t.removeEventListener("click",X,!0)}))}}const ts=`
<symbol id="iconQueryView" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="4362"><path d="M512 128C724.053333 128 896 299.946667 896 512 896 587.093333 874.666667 657.066667 837.12 716.373333L896 775.253333 896 853.333333C896 876.8 876.8 896 853.333333 896L775.68 896 716.373333 837.12C657.493333 874.666667 587.093333 896 512 896 299.946667 896 128 724.053333 128 512 128 299.946667 299.946667 128 512 128M512 298.666667C394.24 298.666667 298.666667 394.24 298.666667 512 298.666667 629.76 394.24 725.333333 512 725.333333 539.733333 725.333333 565.76 720.213333 590.08 710.4L467.2 587.52C433.92 554.666667 433.92 500.053333 467.2 466.773333 500.48 433.493333 554.666667 433.493333 587.946667 466.773333L710.826667 589.653333C720.213333 565.76 725.333333 539.306667 725.333333 512 725.333333 394.24 629.76 298.666667 512 298.666667Z" p-id="4363"></path></symbol>
`;exports.default=es;
